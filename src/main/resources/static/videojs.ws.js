!function(a,b){typeof exports==='object'&&typeof module!=='undefined'?b(require('video.js')):typeof define==='function'&&define.amd?define(['video.js'],b):(b(a.videojs))}(this,(function(f){'use strict';f=f&&f.hasOwnProperty('default')?f['default']:f;let g={Error:0,Warn:1,Log:2,Debug:3},l=g.Debug;class p{constructor(a = l,b){this.tag=b;this.setLevel(a)}setLevel(a){this.level=a}static get level_map(){return{[g.Debug]:'log',[g.Log]:'log',[g.Warn]:'warn',[g.Error]:'error'}}_log(a,b){b=Array.prototype.slice.call(b);this.tag&&b.unshift(`[${this.tag}]`);this.level>=a&&console[p.level_map[a]].apply(console,b)}log(){this._log(g.Log,arguments)}debug(){this._log(g.Debug,arguments)}error(){this._log(g.Error,arguments)}warn(){this._log(g.Warn,arguments)}}let t=new Map();function u(a){t.has(a)||t.set(a,new p(l,a));return t.get(a)}let v=new p();class z{static parse(a){let b={},c=/^([^:]+):\/\/([^\/]+)(.*)$/,d=c.exec(a);if(!d){throw new Error("bad url")}b.full=a;b.protocol=d[1];b.urlpath=d[3];let e=b.urlpath.split('/');b.basename=e.pop().split(/\?|#/)[0];b.basepath=e.join('/');let f=d[2].split('@'),g=f[0].split(':'),h=[null,null];f.length===2&&(h=f[0].split(':'),g=f[1].split(':'));b.user=h[0];b.pass=h[1];b.host=g[0];b.auth=b.user&&b.pass?`${b.user}:${b.pass}`:'';b.port=null==g[1]?z.protocolDefaultPort(b.protocol):g[1];b.portDefined=null!=g[1];b.location=`${b.host}:${b.port}`;b.protocol=='unix'&&(b.socket=b.port,b.port=undefined);return b}static full(a){return`${a.protocol}://${a.location}/${a.urlpath}`}static isAbsolute(a){return /^[^:]+:\/\//.test(a)}static protocolDefaultPort(a){switch(a){case 'rtsp':return 554;case 'http':return 80;case 'https':return 443};return 0}}let A=Symbol("event_listener"),F=Symbol("event_listeners");class G{constructor(a){this[A]=a;this[F]=new Map()}clear(){if(this[F]){for(let a of this[F]){for(let b of a[1])this[A].removeEventListener(a[0],b)}}this[F].clear()}destroy(){this.clear();this[F]=null}on(a,b,c){c==undefined&&(c=b,b=null);if(b){return this.addEventListener(a,a=>{a.target.matches(b)&&c(a)})}else{return this.addEventListener(a,c)}}addEventListener(a,b){this[F].has(a)||this[F].set(a,new Set());this[F].get(a).add(b);this[A].addEventListener(a,b,!1);return b}removeEventListener(a,b){this[A].removeEventListener(a,b,!1);if(this[F].has(a)){let c=this[F].get(a);c.delete(b);c.size||this[F].delete(a)}}dispatchEvent(a){this[A]&&this[A].dispatchEvent(a)}}class H{constructor(a=null){this[A]=new G(a||document.createElement('div'))}clear(){this[A]&&this[A].clear()}destroy(){this[A]&&(this[A].destroy(),this[A]=null)}on(a,b,c){if(this[A]){return this[A].on(a,b,c)}return null}addEventListener(a,b){if(this[A]){return this[A].addEventListener(a,b,!1)}return null}removeEventListener(a,b){this[A]&&this[A].removeEventListener(a,b,!1)}dispatchEvent(a,b){this[A]&&this[A].dispatchEvent(new CustomEvent(a,{detail:b}))}}class I{constructor(a){this.eventSource=a;this[F]=new Map()}on(a,b,c){this[F].has(a)||this[F].set(a,new Set());let d=this.eventSource.on(a,b,c);d&&this[F].get(a).add(d)}off(a,b){this.eventSource.removeEventListener(a,b)}clear(){this.eventSource.clear();this[F].clear()}destroy(){this.eventSource.clear();this[F]=null;this.eventSource=null}}class J{static init(){J.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],mvex:[],mvhd:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};var a;for(a in J.types)J.types.hasOwnProperty(a)&&(J.types[a]=[a.charCodeAt(0),a.charCodeAt(1),a.charCodeAt(2),a.charCodeAt(3)]);var b=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x76,0x69,0x64,0x65,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x56,0x69,0x64,0x65,0x6f,0x48,0x61,0x6e,0x64,0x6c,0x65,0x72,0x00]),c=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x73,0x6f,0x75,0x6e,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x53,0x6f,0x75,0x6e,0x64,0x48,0x61,0x6e,0x64,0x6c,0x65,0x72,0x00]);J.HDLR_TYPES={'video':b,'audio':c};var d=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x0c,0x75,0x72,0x6c,0x20,0x00,0x00,0x00,0x01]),e=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);J.STTS=J.STSC=J.STCO=e;J.STSZ=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);J.VMHD=new Uint8Array([0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);J.SMHD=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00]);J.STSD=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01]);var f=new Uint8Array([105,115,111,109]),g=new Uint8Array([97,118,99,49]),h=new Uint8Array([0,0,0,1]);J.FTYP=J.box(J.types.ftyp,f,h,f,g);J.DINF=J.box(J.types.dinf,J.box(J.types.dref,d))}static box(a,...b){var c=8,d=b.length,e=d,f;while(d--)c+=b[d].byteLength;f=new Uint8Array(c);f[0]=c>>24&0xff;f[1]=c>>16&0xff;f[2]=c>>8&0xff;f[3]=c&0xff;f.set(a,4);for(d=0, c=8;d<e;++d)f.set(b[d],c),c+=b[d].byteLength;return f}static hdlr(a){return J.box(J.types.hdlr,J.HDLR_TYPES[a])}static mdat(a){return J.box(J.types.mdat,a)}static mdhd(a,b){return J.box(J.types.mdhd,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x02,0x00,0x00,0x00,0x03,a>>24&0xFF,a>>16&0xFF,a>>8&0xFF,a&0xFF,b>>24,b>>16&0xFF,b>>8&0xFF,b&0xFF,0x55,0xc4,0x00,0x00]))}static mdia(a){return J.box(J.types.mdia,J.mdhd(a.timescale,a.duration),J.hdlr(a.type),J.minf(a))}static mfhd(a){return J.box(J.types.mfhd,new Uint8Array([0x00,0x00,0x00,0x00,a>>24,a>>16&0xFF,a>>8&0xFF,a&0xFF]))}static minf(a){if(a.type==='audio'){return J.box(J.types.minf,J.box(J.types.smhd,J.SMHD),J.DINF,J.stbl(a))}else{return J.box(J.types.minf,J.box(J.types.vmhd,J.VMHD),J.DINF,J.stbl(a))}}static moof(a,b,c){return J.box(J.types.moof,J.mfhd(a),J.traf(c,b))}static moov(a,b,c){vard=a.length,e=[];while(d--)e[d]=J.trak(a[d]);return J.box.apply(null,[J.types.moov,J.mvhd(c,b)].concat(e).concat(J.mvex(a)))}static mvex(a){varb=a.length,c=[];while(b--)c[b]=J.trex(a[b]);return J.box.apply(null,[J.types.mvex].concat(c))}static mvhd(a,b){varc=new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x02,a>>24&0xFF,a>>16&0xFF,a>>8&0xFF,a&0xFF,b>>24&0xFF,b>>16&0xFF,b>>8&0xFF,b&0xFF,0x00,0x01,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xff,0xff,0xff,0xff]);return J.box(J.types.mvhd,c)}static sdtp(a){varb=a.samples||[],c=new Uint8Array(4+b.length),d,e;for(e=0;e<b.length;e++)d=b[e].flags,c[e+4]=d.dependsOn<<4|d.isDependedOn<<2|d.hasRedundancy;return J.box(J.types.sdtp,c)}static stbl(a){return J.box(J.types.stbl,J.stsd(a),J.box(J.types.stts,J.STTS),J.box(J.types.stsc,J.STSC),J.box(J.types.stsz,J.STSZ),J.box(J.types.stco,J.STCO))}static avc1(a){var b=[],c=[],d,e,f;for(d=0;d<a.sps.length;d++)e=a.sps[d],f=e.byteLength,b.push(f>>>8&0xFF),b.push((f&0xFF)),b=b.concat(Array.prototype.slice.call(e));for(d=0;d<a.pps.length;d++)e=a.pps[d],f=e.byteLength,c.push(f>>>8&0xFF),c.push((f&0xFF)),c=c.concat(Array.prototype.slice.call(e));var g=J.box(J.types.avcC,new Uint8Array([0x01,b[3],b[4],b[5],255,0xE0|a.sps.length].concat(b).concat([a.pps.length]).concat(c))),h=a.width,i=a.height;return J.box(J.types.avc1,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,h>>8&0xFF,h&0xff,i>>8&0xFF,i&0xff,0x00,0x48,0x00,0x00,0x00,0x48,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x12,0x62,0x69,0x6E,0x65,0x6C,0x70,0x72,0x6F,0x2E,0x72,0x75,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x11,0x11]),g,J.box(J.types.btrt,new Uint8Array([0x00,0x1c,0x9c,0x80,0x00,0x2d,0xc6,0xc0,0x00,0x2d,0xc6,0xc0])))}static esds(a){var b=a.config.byteLength;let c=new Uint8Array(26+b+3);c.set([0x00,0x00,0x00,0x00,0x03,0x17+b,0x00,0x01,0x00,0x04,0x0f+b,0x40,0x15,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x05,b]);c.set(a.config,26);c.set([0x06,0x01,0x02],26+b);return c}static mp4a(a){var b=a.audiosamplerate;return J.box(J.types.mp4a,new Uint8Array([0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,a.channelCount,0x00,0x10,0x00,0x00,0x00,0x00,b>>8&0xFF,b&0xff,0x00,0x00]),J.box(J.types.esds,J.esds(a)))}static stsd(a){if(a.type==='audio'){return J.box(J.types.stsd,J.STSD,J.mp4a(a))}else{return J.box(J.types.stsd,J.STSD,J.avc1(a))}}static tkhd(a){var b=a.id,c=a.duration,d=a.width,e=a.height,f=a.volume;return J.box(J.types.tkhd,new Uint8Array([0x00,0x00,0x00,0x07,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,b>>24&0xFF,b>>16&0xFF,b>>8&0xFF,b&0xFF,0x00,0x00,0x00,0x00,c>>24,c>>16&0xFF,c>>8&0xFF,c&0xFF,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,f>>0&0xff,f%1*10>>0&0xff,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x40,0x00,0x00,0x00,d>>8&0xFF,d&0xFF,0x00,0x00,e>>8&0xFF,e&0xFF,0x00,0x00]))}static traf(a,b){var c=J.sdtp(a),d=a.id;return J.box(J.types.traf,J.box(J.types.tfhd,new Uint8Array([0x00,0x00,0x00,0x00,d>>24,d>>16&0XFF,d>>8&0XFF,d&0xFF])),J.box(J.types.tfdt,new Uint8Array([0x00,0x00,0x00,0x00,b>>24,b>>16&0XFF,b>>8&0XFF,b&0xFF])),J.trun(a,c.length+16+16+8+16+8+8),c)}static trak(a){a.duration=a.duration||0xffffffff;return J.box(J.types.trak,J.tkhd(a),J.mdia(a))}static trex(a){var b=a.id;return J.box(J.types.trex,new Uint8Array([0x00,0x00,0x00,0x00,b>>24,b>>16&0XFF,b>>8&0XFF,b&0xFF,0x00,0x00,0x00,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x00,0x01]))}static trun(a,b){var c=a.samples||[],d=c.length,e=12+16*d,f=new Uint8Array(e),g,h,i,j,k,l;b+=8+e;f.set([0x00,0x00,0x0f,0x01,d>>>24&0xFF,d>>>16&0xFF,d>>>8&0xFF,d&0xFF,b>>>24&0xFF,b>>>16&0xFF,b>>>8&0xFF,b&0xFF],0);for(g=0;g<d;g++)h=c[g],i=h.duration,j=h.size,k=h.flags,l=h.cts,f.set([i>>>24&0xFF,i>>>16&0xFF,i>>>8&0xFF,i&0xFF,j>>>24&0xFF,j>>>16&0xFF,j>>>8&0xFF,j&0xFF,k.isLeading<<2|k.dependsOn,k.isDependedOn<<6|k.hasRedundancy<<4|k.paddingValue<<1|k.isNonSync,k.degradPrio&61440,k.degradPrio&0x0F,l>>>24&0xFF,l>>>16&0xFF,l>>>8&0xFF,l&0xFF],12+16*g);return J.box(J.types.trun,f)}static initSegment(a,b,c){J.types||J.init();var d=J.moov(a,b,c),e;e=new Uint8Array(J.FTYP.byteLength+d.byteLength);e.set(J.FTYP);e.set(d,J.FTYP.byteLength);return e}}let K="mse",L=u(K);class M{constructor(a,b){this.mediaSource=a.mediaSource;this.players=a.players;this.cleaning=!1;this.parent=a;this.queue=[];this.cleanResolvers=[];this.codec=b;this.cleanRanges=[];L.debug(`Use codec: ${b}`);this.sourceBuffer=this.mediaSource.addSourceBuffer(b);this.eventSource=new H(this.sourceBuffer);this.eventSource.addEventListener('updatestart',a=>{this.cleaning&&L.debug(`${this.codec} cleaning start`)});this.eventSource.addEventListener('update',a=>{this.cleaning&&L.debug(`${this.codec} cleaning update`)});this.eventSource.addEventListener('updateend',a=>{if(this.cleaning){L.debug(`${this.codec} cleaning end`);try{this.sourceBuffer.buffered.length&&this.players[0].currentTime<this.sourceBuffer.buffered.start(0)&&(this.players[0].currentTime=this.sourceBuffer.buffered.start(0))}catch(a){};while(this.cleanResolvers.length){let a=this.cleanResolvers.shift();a()}this.cleaning=!1;if(this.cleanRanges.length){this.doCleanup();return}}this.feedNext()});this.eventSource.addEventListener('error',a=>{L.debug(`Source buffer error: ${this.mediaSource.readyState}`);this.mediaSource.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(this.sourceBuffer);this.parent.eventSource.dispatchEvent('error')});this.eventSource.addEventListener('abort',a=>{L.debug(`Source buffer aborted: ${this.mediaSource.readyState}`);this.mediaSource.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(this.sourceBuffer);this.parent.eventSource.dispatchEvent('error')});this.sourceBuffer.updating||this.feedNext()}destroy(){this.eventSource.destroy();this.clear();this.queue=[];this.mediaSource.removeSourceBuffer(this.sourceBuffer)}clear(){this.queue=[];let a=[];for(let b=0;b<this.sourceBuffer.buffered.length;++b)this.cleaning=!0,a.push(new Promise((a,c)=>{this.cleanResolvers.push(a);this.sourceBuffer.updating?(this.sourceBuffer.onupdateend=()=>{this.sourceBuffer&&this.sourceBuffer.remove(this.sourceBuffer.buffered.start(b),this.sourceBuffer.buffered.end(b));a()}):(this.sourceBuffer.remove(this.sourceBuffer.buffered.start(b),this.sourceBuffer.buffered.end(b)),a())}));return Promise.all(a)}setLive(a){this.is_live=a}feedNext(){!this.sourceBuffer.updating&&!this.cleaning&&this.queue.length&&this.doAppend(this.queue.shift())}doCleanup(){if(!this.cleanRanges.length){this.cleaning=!1;this.feedNext();return}let a=this.cleanRanges.shift();L.debug(`${this.codec} remove range [${a[0]} - ${a[1]}). 
                    \nUpdating: ${this.sourceBuffer.updating}
                    `);this.cleaning=!0;this.sourceBuffer.remove(a[0],a[1])}initCleanup(){if(this.sourceBuffer.buffered.length&&!this.sourceBuffer.updating&&!this.cleaning){L.debug(`${this.codec} cleanup`);let a=this.sourceBuffer.buffered.end(this.sourceBuffer.buffered.length-1)-2;for(let b=0;b<this.sourceBuffer.buffered.length;++b){let c=this.sourceBuffer.buffered.start(b),d=this.sourceBuffer.buffered.end(b);if(this.players[0].currentTime<=c||a<=c)continue;if(a<=d&&a>=c){L.debug(`Clear [${c}, ${a}), leave [${a}, ${d}]`);d=a;d!=c&&this.cleanRanges.push([c,d]);continue}this.cleanRanges.push([c,d])}this.doCleanup()}else this.feedNext()}doAppend(a){let b=this.players[0].error;if(b){L.error(`Error occured: ${O.ErrorNotes[b.code]}`);try{this.players.forEach(a=>{a.stop()}),this.mediaSource.endOfStream()}catch(a){};this.parent.eventSource.dispatchEvent('error')}else{try{this.sourceBuffer.appendBuffer(a)}catch(b){if(b.name==='QuotaExceededError'){L.debug(`${this.codec} quota fail`);this.queue.unshift(a);this.initCleanup();return}L.error(`Error occured while appending buffer. ${b.name}: ${b.message}`);this.parent.eventSource.dispatchEvent('error')}}}feed(a){this.queue=this.queue.concat(a);this.sourceBuffer&&!this.sourceBuffer.updating&&!this.cleaning&&this.feedNext()}}class O{static get ErrorNotes(){return{[MediaError.MEDIA_ERR_ABORTED]:'fetching process aborted by user',[MediaError.MEDIA_ERR_NETWORK]:'error occurred when downloading',[MediaError.MEDIA_ERR_DECODE]:'error occurred when decoding',[MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED]:'audio/video not supported'}}static isSupported(a){return window.MediaSource&&window.MediaSource.isTypeSupported(`video/mp4; codecs="${a.join(',')}"`)}constructor(a){this.players=a;let b=this.players.map((a,c)=>{a.onplaying=function(){b[c]=!0};a.onpause=function(){b[c]=!1};return!a.paused});this.playing=b;this.mediaSource=new MediaSource();this.eventSource=new H(this.mediaSource);this.reset()}destroy(){this.reset();this.eventSource.destroy();this.mediaSource=null;this.eventSource=null}play(){this.players.forEach((a,b)=>{a.paused&&!this.playing[b]&&(L.debug(`player ${b}: play`),a.play())})}setLive(a){for(let b in this.buffers)this.buffers[b].setLive(a);this.is_live=a}resetBuffers(){this.players.forEach((a,b)=>{!a.paused&&this.playing[b]&&(a.pause(),a.currentTime=0)});let a=[];for(let b of this.buffers.values())a.push(b.clear());return Promise.all(a).then(()=>{this.mediaSource.endOfStream();this.mediaSource.duration=0;this.mediaSource.clearLiveSeekableRange();this.play()})}clear(){this.reset();this.players.forEach(a=>{a.src=URL.createObjectURL(this.mediaSource)});return this.setupEvents()}setupEvents(){this.eventSource.clear();this.resolved=!1;this.mediaReady=new Promise((a,b)=>{this._sourceOpen=()=>{L.debug(`Media source opened: ${this.mediaSource.readyState}`);this.resolved||(this.resolved=!0,a())};this._sourceEnded=()=>{L.debug(`Media source ended: ${this.mediaSource.readyState}`)};this._sourceClose=()=>{L.debug(`Media source closed: ${this.mediaSource.readyState}`);this.resolved&&this.eventSource.dispatchEvent('sourceclosed')};this.eventSource.addEventListener('sourceopen',this._sourceOpen);this.eventSource.addEventListener('sourceended',this._sourceEnded);this.eventSource.addEventListener('sourceclose',this._sourceClose)});return this.mediaReady}reset(){this.ready=!1;for(let a in this.buffers)this.buffers[a].destroy(),delete this.buffers[a];this.mediaSource.readyState=='open'&&(this.mediaSource.duration=0,this.mediaSource.endOfStream());this.updating=!1;this.resolved=!1;this.buffers={}}setCodec(a,b){return this.mediaReady.then(()=>{this.buffers[a]=new M(this,b);this.buffers[a].setLive(this.is_live)})}feed(a,b){this.buffers[a]&&this.buffers[a].feed(b)}}let R=u('remuxer:base'),S=1;class T{static get MP4_TIMESCALE(){return 90000}static getTrackID(){return S++}constructor(a,b,c){this.timeOffset=0;this.timescale=a;this.scaleFactor=b;this.readyToDecode=!1;this.samples=[];this.seq=1;this.tsAlign=1}scaled(a){return a/this.scaleFactor}unscaled(a){return a*this.scaleFactor}remux(a){if(a){this.samples.push({unit:a,pts:a.pts,dts:a.dts});return !0}return !1}static toMS(a){return a/90}setConfig(a){}insertDscontinuity(){this.samples.push(null)}init(a,b,c=!0){this.initPTS=Math.min(a,this.samples[0].dts);this.initDTS=Math.min(b,this.samples[0].dts);R.debug(`Initial pts=${this.initPTS} dts=${this.initDTS} offset=${this.unscaled(this.timeOffset)}`);this.initialized=c}flush(){this.seq++;this.mp4track.len=0;this.mp4track.samples=[]}static dtsSortFunc(a,b){return a.dts-b.dts}static groupByDts(a){let b=(a,b)=>{return a.reduce((a,c)=>{(a[c[b]]=a[c[b]]||[]).push(c);return a},{})};return b(a,'dts')}getPayloadBase(a,b){if(!this.readyToDecode||!this.initialized||!this.samples.length)return null;this.samples.sort(T.dtsSortFunc);return !0}}let U=u("remuxer:aac");class V extends T{constructor(a,b = 1,c={}){super(a,b);this.codecstring=O.CODEC_AAC;this.units=[];this.initDTS=undefined;this.nextAacPts=undefined;this.lastPts=0;this.firstDTS=0;this.firstPTS=0;this.duration=c.duration||1;this.initialized=!1;this.mp4track={id:T.getTrackID(),type:'audio',fragmented:!0,channelCount:0,audiosamplerate:this.timescale,duration:0,timescale:this.timescale,volume:1,samples:[],config:'',len:0};c.config&&this.setConfig(c.config)}setConfig(a){this.mp4track.channelCount=a.channels;this.mp4track.audiosamplerate=a.samplerate;this.mp4track.duration||(this.mp4track.duration=(this.duration?this.duration:1)*a.samplerate);this.mp4track.timescale=a.samplerate;this.mp4track.config=a.config;this.mp4track.codec=a.codec;this.timescale=a.samplerate;this.scaleFactor=T.MP4_TIMESCALE/a.samplerate;this.expectedSampleDuration=1024*this.scaleFactor;this.readyToDecode=!0}remux(a){super.remux.call(this,a)&&(this.mp4track.len+=a.getSize())}getPayload(){if(!this.readyToDecode||!this.samples.length)return null;this.samples.sort(function(a,b){return a.dts-b.dts});let c=new Uint8Array(this.mp4track.len),d=0,e=this.mp4track.samples,f,g,h,i;while(this.samples.length){let a=this.samples.shift();if(a===null){this.nextDts=undefined;break}let b=a.unit;h=a.pts-this.initDTS;i=a.dts-this.initDTS;if(g===undefined){if(this.nextDts){let a=Math.round(this.scaled(h-this.nextAacPts));if(Math.abs(a)<600){if(a){if(a>0)U.log(`${a} ms hole between AAC samples detected,filling it`);else if(a<-12){U.log(`${-a} ms overlapping between AAC samples detected, drop frame`);this.mp4track.len-=b.getSize();continue};h=i=this.nextAacPts}}}this.firstDTS=Math.max(0,i)}f={size:b.getSize(),cts:0,duration:1024,flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:1}};c.set(b.getData(),d);d+=b.getSize();e.push(f);g=i}if(!e.length)return null;this.nextDts=h+this.expectedSampleDuration;return new Uint8Array(c.buffer,0,this.mp4track.len)}}class W{constructor(a){this.data=a;this.bytesAvailable=this.data.byteLength;this.word=0;this.bitsAvailable=0}loadWord(){vara=this.data.byteLength-this.bytesAvailable,b=new Uint8Array(4),c=Math.min(4,this.bytesAvailable);if(c===0){throw new Error('no bytes available')}b.set(this.data.subarray(a,a+c));this.word=new DataView(b.buffer,b.byteOffset,b.byteLength).getUint32(0);this.bitsAvailable=c*8;this.bytesAvailable-=c}skipBits(a){var b;this.bitsAvailable>a?(this.word<<=a,this.bitsAvailable-=a):(a-=this.bitsAvailable,b=a>>3,a-=b<<3,this.bytesAvailable-=b,this.loadWord(),this.word<<=a,this.bitsAvailable-=a)}readBits(a){varb=Math.min(this.bitsAvailable,a),c=this.word>>>32-b;a>32&&v.error('Cannot read more than 32 bits at a time');this.bitsAvailable-=b;this.bitsAvailable>0?(this.word<<=b):this.bytesAvailable>0&&this.loadWord();b=a-b;if(b>0){return c<<b|this.readBits(b)}else{return c}}skipLZ(){var a;for(a=0;a<this.bitsAvailable;++a){if(0!==(this.word&0x80000000>>>a)){this.word<<=a;this.bitsAvailable-=a;return a}}this.loadWord();return a+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){var a=this.skipLZ();return this.readBits(a+1)-1}readEG(){var a=this.readUEG();if(0x01&a){return 1+a>>>1}else{return-1*(a>>>1)}}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}}function X(a,b){let c=new Uint8Array((a.byteLength|0)+(b.byteLength|0));c.set(a,0);c.set(b,a.byteLength|0);return c}function Y(a){var b=window.atob(a),c=b.length,d=new Uint8Array(c);for(var e=0;e<c;e++)d[e]=b.charCodeAt(e);return d.buffer}function Z(a){let b=a.length>>1;var c=new Uint8Array(b);for(var d=0;d<b;d++)c[d]=parseInt(a.substr(d<<1,2),16);return c}function _(a,b=0,c=bytearray.byteLength*8){let d=Math.ceil((c-b)/8),e=new Uint8Array(d),f=b>>>3,g=(c>>>3)-1,h=b&0x7,i=8-h,j=8-c&0x7;for(let b=0;b<d;++b){let c=0;b<g&&(c=a[f+b+1]>>i,b==g-1&&j<8&&(c>>=j,c<<=j));e[b]=a[f+b]<<h|c}return e}class ${constructor(a){this.src=new DataView(a.buffer,a.byteOffset,a.byteLength);this.bitpos=0;this.byte=this.src.getUint8(0);this.bytepos=0}readBits(a){if(32<(a|0)||0===(a|0)){throw new Error("too big")}let b=0;for(let c=a;c>0;--c)b=(b|0)<<1|(this.byte|0)>>8-++this.bitpos&0x01,(this.bitpos|0)>=8&&(this.byte=this.src.getUint8(++this.bytepos),this.bitpos&=0x7);return b}skipBits(a){this.bitpos+=(a|0)&0x7;this.bytepos+=(a|0)>>>3;this.bitpos>7&&(this.bitpos&=0x7,++this.bytepos);if(!this.finished()){this.byte=this.src.getUint8(this.bytepos);return 0}else{return this.bytepos-this.src.byteLength-this.src.bitpos}}finished(){return this.bytepos>=this.src.byteLength}}class aa{static get NDR(){return 1}static get SLICE_PART_A(){return 2}static get SLICE_PART_B(){return 3}static get SLICE_PART_C(){return 4}static get IDR(){return 5}static get SEI(){return 6}static get SPS(){return 7}static get PPS(){return 8}static get DELIMITER(){return 9}static get EOSEQ(){return 10}static get EOSTR(){return 11}static get FILTER(){return 12}static get STAP_A(){return 24}static get STAP_B(){return 25}static get FU_A(){return 28}static get FU_B(){return 29}static get TYPES(){return{[aa.IDR]:'IDR',[aa.SEI]:'SEI',[aa.SPS]:'SPS',[aa.PPS]:'PPS',[aa.NDR]:'NDR'}}static type(a){if(a.ntype in aa.TYPES){return aa.TYPES[a.ntype]}else{return'UNKNOWN'}}constructor(a,b,c,d,e){this.data=c;this.ntype=a;this.nri=b;this.dts=d;this.pts=e?e:this.dts;this.sliceType=null}appendData(a){this.data=X(this.data,a)}toString(){return`${aa.type(this)}(${this.data.byteLength}): NRI: ${this.getNri()}, PTS: ${this.pts}, DTS: ${this.dts}`}getNri(){return this.nri>>5}type(){return this.ntype}isKeyframe(){return this.ntype===aa.IDR||this.sliceType===7}getSize(){return 5+this.data.byteLength}getData(){let a=new Uint8Array(5+this.data.byteLength),b=new DataView(a.buffer);b.setUint32(0,this.data.byteLength+1);b.setUint8(4,0|this.nri&0x60|this.ntype&0x1F);a.set(this.data,5);return a}}class ab{constructor(a){this.remuxer=a;this.track=a.mp4track;this.firstFound=!1}msToScaled(a){return(a-this.remuxer.timeOffset)*this.remuxer.scaleFactor}parseSPS(a){var b=ab.readSPS(new Uint8Array(a));this.track.width=b.width;this.track.height=b.height;this.track.sps=[new Uint8Array(a)];this.track.codec='avc1.';let c=new DataView(a.buffer,a.byteOffset+1,4);for(let a=0;a<3;++a){var d=c.getUint8(a).toString(16);d.length<2&&(d='0'+d);this.track.codec+=d}}parsePPS(a){this.track.pps=[new Uint8Array(a)]}parseNAL(a){if(!a)return !1;let b=null;switch(a.type()){case aa.NDR:;case aa.IDR:a.sliceType=ab.parceSliceHeader(a.data);a.isKeyframe()&&!this.firstFound&&(this.firstFound=!0);this.firstFound?(b=!0):(b=!1);break;case aa.PPS:b=!1;this.track.pps||(this.parsePPS(a.getData().subarray(4)),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0));break;case aa.SPS:b=!1;this.track.sps||(this.parseSPS(a.getData().subarray(4)),!this.remuxer.readyToDecode&&this.track.pps&&this.track.sps&&(this.remuxer.readyToDecode=!0));break;case aa.SEI:b=!1;let h=new DataView(a.data.buffer,a.data.byteOffset,a.data.byteLength);let g=0;let f=h.getUint8(g);++g;let e=0;let d=h.getUint8(g);++g;while(d===255)e+=d,d=h.getUint8(g),++g;e+=d;let c=a.data.subarray(g,g+16);g+=16;console.log(`PT: ${f}, PS: ${e}, UUID: ${Array.from(c).map(function(a){return('0'+a.toString(16)).slice(-2)}).join('')}`);break;case aa.EOSEQ:;case aa.EOSTR:b=!1;default:};b===null&&a.getNri()>0&&(b=!0);return b}static parceSliceHeader(a){let b=new W(a),d=b.readUEG();return d}static skipScalingList(a,b){let c=8,d=8,e;for(let f=0;f<b;f++)d!==0&&(e=a.readEG(),d=(c+e+256)%256),c=d===0?c:d}static readSPS(a){let b=new W(a),c=0,d=0,e=0,f=0,g=1,h,i,j,k,l,m,n,o;b.readUByte();h=b.readUByte();i=b.readBits(5);b.skipBits(3);j=b.readUByte();b.skipUEG();if(h===100||h===110||h===122||h===244||h===44||h===83||h===86||h===118||h===128){var p=b.readUEG();p===3&&b.skipBits(1);b.skipUEG();b.skipUEG();b.skipBits(1);if(b.readBoolean()){o=p!==3?8:12;for(let a=0;a<o;++a)b.readBoolean()&&(a<6?ab.skipScalingList(b,16):ab.skipScalingList(b,64))}}b.skipUEG();var q=b.readUEG();if(q===0)b.readUEG();else if(q===1){b.skipBits(1);b.skipEG();b.skipEG();k=b.readUEG();for(let a=0;a<k;++a)b.skipEG()};b.skipUEG();b.skipBits(1);l=b.readUEG();m=b.readUEG();n=b.readBits(1);n===0&&b.skipBits(1);b.skipBits(1);b.readBoolean()&&(c=b.readUEG(),d=b.readUEG(),e=b.readUEG(),f=b.readUEG());if(b.readBoolean()){if(b.readBoolean()){let a,c=b.readUByte();switch(c){case 1:a=[1,1];break;case 2:a=[12,11];break;case 3:a=[10,11];break;case 4:a=[16,11];break;case 5:a=[40,33];break;case 6:a=[24,11];break;case 7:a=[20,11];break;case 8:a=[32,11];break;case 9:a=[80,33];break;case 10:a=[18,11];break;case 11:a=[15,11];break;case 12:a=[64,33];break;case 13:a=[160,99];break;case 14:a=[4,3];break;case 15:a=[3,2];break;case 16:a=[2,1];break;case 255:{a=[b.readUByte()<<8|b.readUByte(),b.readUByte()<<8|b.readUByte()];break}};a&&(g=a[0]/a[1])}b.readBoolean()&&b.skipBits(1);b.readBoolean()&&(b.skipBits(4),b.readBoolean()&&b.skipBits(24));b.readBoolean()&&(b.skipUEG(),b.skipUEG());if(b.readBoolean()){let a=b.readUInt(),c=b.readUInt(),d=b.readBoolean(),e=c/(2*a);console.log(`timescale: ${c}; unitsInTick: ${a}; fixedFramerate: ${d}; avgFrameDuration: ${e}`)}}return{width:Math.ceil(((l+1)*16-c*2-d*2)*g),height:(2-n)*(m+1)*16-(n?2:4)*(e+f)}}static readSliceType(a){a.readUByte();a.readUEG();return a.readUEG()}}let ac=u("remuxer:h264");class ad extends T{constructor(a,b=1,c={}){super(a,b);this.nextDts=undefined;this.readyToDecode=!1;this.initialized=!1;this.firstDTS=0;this.firstPTS=0;this.lastDTS=undefined;this.lastSampleDuration=0;this.lastDurations=[];this.tsAlign=Math.round(this.timescale/60);this.mp4track={id:T.getTrackID(),type:'video',len:0,fragmented:!0,sps:'',pps:'',width:0,height:0,timescale:a,duration:a,samples:[]};this.samples=[];this.lastGopDTS=-99999999999999;this.gop=[];this.firstUnit=!0;this.h264=new ab(this);if(c.sps){let a=new Uint8Array(c.sps);(a[0]&0x1f)===7?this.setSPS(a):ac.warn("bad SPS in SDP")}if(c.pps){let a=new Uint8Array(c.pps);(a[0]&0x1f)===8?this.setPPS(a):ac.warn("bad PPS in SDP")}this.mp4track.pps&&this.mp4track.sps&&(this.readyToDecode=!0)}_scaled(a){return a>>>this.scaleFactor}_unscaled(a){return a<<this.scaleFactor}setSPS(a){this.h264.parseSPS(a)}setPPS(a){this.h264.parsePPS(a)}remux(a){if(this.lastGopDTS<a.dts){this.gop.sort(T.dtsSortFunc);if(this.gop.length>1){let a=T.groupByDts(this.gop);this.gop=Object.values(a).map(a=>{return a.reduce((a,b)=>{let c=b.getData();c.set(new Uint8Array([0x0,0x0,0x0,0x1]));a.appendData(c);return a})})}for(let a of this.gop)super.remux.call(this,a)&&(this.mp4track.len+=a.getSize());this.gop=[];this.lastGopDTS=a.dts}this.h264.parseNAL(a)&&this.gop.push(a)}getPayload(){if(!this.getPayloadBase()){return null}let c=new Uint8Array(this.mp4track.len),d=0,e=this.mp4track.samples,f,g,h,i;while(this.samples.length){let a=this.samples.shift();if(a===null){this.nextDts=undefined;break}let b=a.unit;h=a.pts-this.initDTS;i=a.dts-this.initDTS;i=Math.min(h,i);if(g!==undefined){let a=this.scaled(i-g);if(a<0){ac.log(`invalid AVC sample duration at PTS/DTS: ${h}/${i}|lastDTS: ${g}:${a}`);this.mp4track.len-=b.getSize();continue}this.lastDurations.push(a);this.lastDurations.length>100&&this.lastDurations.shift();f.duration=a}else{if(this.nextDts){let a=i-this.nextDts;if(Math.abs(Math.round(T.toMS(a)))<600)a&&(i=this.nextDts,h=Math.max(h-a,i));else{if(a<0){ac.log(`skip frame from the past at DTS=${i} with expected DTS=${this.nextDts}`);this.mp4track.len-=b.getSize();continue}}}this.firstDTS=Math.max(0,i)}f={size:b.getSize(),duration:0,cts:this.scaled(h-i),flags:{isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0}};let j=f.flags;a.unit.isKeyframe()===!0?(j.dependsOn=2,j.isNonSync=0):(j.dependsOn=1,j.isNonSync=1);c.set(b.getData(),d);d+=b.getSize();e.push(f);g=i}if(!e.length)return null;let j=this.lastDurations.reduce(function(a,b){return(a|0)+(b|0)},0)/(this.lastDurations.length||1)|0;e.length>=2?(this.lastSampleDuration=j,f.duration=j):(f.duration=this.lastSampleDuration);if(e.length&&(!this.nextDts||navigator.userAgent.toLowerCase().indexOf('chrome')>-1)){let a=e[0].flags;a.dependsOn=2;a.isNonSync=0}this.nextDts=i+this.unscaled(this.lastSampleDuration);return new Uint8Array(c.buffer,0,this.mp4track.len)}}class ae{static get VIDEO(){return 1}static get AUDIO(){return 2}static get map(){return{[ae.VIDEO]:'video',[ae.AUDIO]:'audio'}}}class af{static get H264(){return 1}static get AAC(){return 2}static get map(){return{[af.H264]:'video',[af.AAC]:'audio'}}static get string_map(){return{H264:af.H264,AAC:af.AAC,'MP4A-LATM':af.AAC,'MPEG4-GENERIC':af.AAC}}}let ag="remuxer",ah=u(ag);class ai{static get TrackConverters(){return{[af.H264]:ad,[af.AAC]:V}}static get TrackScaleFactor(){return{[af.H264]:1,[af.AAC]:0}}static get TrackTimescale(){return{[af.H264]:90000,[af.AAC]:0}}constructor(a){this.mse=new O([a]);this.eventSource=new H();this.mseEventSource=new I(this.mse.eventSource);this.mse_ready=!0;this.reset();this.errorListener=this.mseClose.bind(this);this.closeListener=this.mseClose.bind(this);this.errorDecodeListener=this.mseErrorDecode.bind(this);this.eventSource.addEventListener('ready',this.init.bind(this))}initMSEHandlers(){this.mseEventSource.on('error',this.errorListener);this.mseEventSource.on('sourceclosed',this.closeListener);this.mseEventSource.on('errordecode',this.errorDecodeListener)}async reset(){this.tracks={};this.initialized=!1;this.initSegments={};this.codecs=[];this.streams={};this.enabled=!1;await this.mse.clear();this.initMSEHandlers()}destroy(){this.mseEventSource.destroy();this.mse.destroy();this.mse=null;this.detachClient();this.eventSource.destroy()}onTracks(a){ah.debug("ontracks: ",a.detail);for(let b of a.detail)this.tracks[b.type]=new ai.TrackConverters[b.type](ai.TrackTimescale[b.type],ai.TrackScaleFactor[b.type],b.params),b.offset&&(this.tracks[b.type].timeOffset=b.offset),b.duration?(this.tracks[b.type].mp4track.duration=b.duration*(this.tracks[b.type].timescale||ai.TrackTimescale[b.type]),this.tracks[b.type].duration=b.duration):(this.tracks[b.type].duration=1);this.mse.setLive(!this.client.seekable)}setTimeOffset(a,b){this.tracks[b.type]&&(this.tracks[b.type].timeOffset=a)}init(){let a=[];this.codecs=[];let b=[],c=Infinity,d=Infinity;for(let b in this.tracks){let e=this.tracks[b];if(!O.isSupported([e.mp4track.codec])){throw new Error(`${e.mp4track.type} codec ${e.mp4track.codec} is not supported`)}a.push(e.mp4track);this.codecs.push(e.mp4track.codec);e.init(c,d)}for(let a in this.tracks){let c=this.tracks[a];this.initSegments[a]=J.initSegment([c.mp4track],c.duration*c.timescale,c.timescale);b.push(this.initMSE(a,c.mp4track.codec))}this.initialized=!0;return Promise.all(b).then(()=>{this.enabled=!0})}initMSE(a,b){if(O.isSupported(this.codecs)){return this.mse.setCodec(a,`${af.map[a]}/mp4; codecs="${b}"`).then(()=>{this.mse.feed(a,this.initSegments[a])})}else{throw new Error('Codecs are not supported')}}mseClose(){this.client.stop();this.eventSource.dispatchEvent('stopped')}mseErrorDecode(){this.tracks[2]&&(console.warn(this.tracks[2].mp4track.type),this.mse.buffers[2].destroy(),delete this.tracks[2])}flush(){this.onSamples();if(!this.initialized){if(Object.keys(this.tracks).length){for(let a in this.tracks){if(!this.tracks[a].readyToDecode||!this.tracks[a].samples.length)return;ah.debug(`Init MSE for track ${this.tracks[a].mp4track.type}`)}this.eventSource.dispatchEvent('ready')}}else{for(let a in this.tracks){let b=this.tracks[a],c=b.getPayload();c&&c.byteLength&&(this.mse.feed(a,[J.moof(b.seq,b.scaled(b.firstDTS),b.mp4track),J.mdat(c)]),b.flush())}}}onSamples(a){for(let a in this.client.sampleQueues){let b=this.client.sampleQueues[a];while(b.length){let c=b.shift();if(c){for(let b of c)this.tracks[a]&&this.tracks[a].remux(b)}else this.initialized||delete this.tracks[a]}}}onAudioConfig(a){this.tracks[a.detail.pay]&&this.tracks[a.detail.pay].setConfig(a.detail.config)}attachClient(a){this.detachClient();this.client=a;this.clientEventSource=new I(this.client.eventSource);this.clientEventSource.on('samples',this.samplesListener);this.clientEventSource.on('audio_config',this.audioConfigListener);this.clientEventSource.on('tracks',this.onTracks.bind(this));this.clientEventSource.on('flush',this.flush.bind(this));this.clientEventSource.on('clear',()=>{this.reset();this.mse.clear().then(()=>{this.initMSEHandlers()})})}detachClient(){this.client&&(this.clientEventSource.destroy(),this.client=null)}}class aj{constructor(a,b){this.stateMachine=b;this.transitions=new Set();this.name=a}activate(){return Promise.resolve(null)}finishTransition(){}failHandler(){}deactivate(){return Promise.resolve(null)}}class ak{constructor(){this.storage={};this.currentState=null;this.states=new Map()}addState(a,{activate:b,finishTransition:c,deactivate:d}){let e=new aj(a,this);b&&(e.activate=b);c&&(e.finishTransition=c);d&&(e.deactivate=d);this.states.set(a,e);return this}addTransition(a,b){if(!this.states.has(a)){throw ReferenceError(`No such state: ${a} while connecting to ${b}`)}if(!this.states.has(b)){throw ReferenceError(`No such state: ${b} while connecting from ${a}`)}this.states.get(a).transitions.add(b);return this}_promisify(a){let b;try{b=a,b.then||(b=Promise.resolve(b))}catch(a){b=Promise.reject(a)};return b}transitionTo(a){if(this.currentState==null){let b=this.states.get(a);return this._promisify(b.activate.call(this)).then(a=>{this.currentState=b;return a}).then(b.finishTransition.bind(this)).catch(a=>{b.failHandler();throw a})}if(this.currentState.name==a)return Promise.resolve();if(this.currentState.transitions.has(a)){let b=this.states.get(a);return this._promisify(b.deactivate.call(this)).then(b.activate.bind(this)).then(a=>{this.currentState=b;return a}).then(b.finishTransition.bind(this)).catch(a=>{b.failHandler();throw a})}else{return Promise.reject(`No such transition: ${this.currentState.name} to ${a}`)}}}let al=u("parser:sdp");class am{constructor(){this.version=-1;this.origin=null;this.sessionName=null;this.timing=null;this.sessionBlock={};this.media={};this.tracks={};this.mediaMap={}}parse(a){return new Promise((b,c)=>{var d=a,e=!0,f=this.sessionBlock;for(let a of d.split("\n")){a=a.replace(/\r/,'');if(0===a.length){continue}switch(a.charAt(0)){case 'v':if(-1!==this.version){al.log('Version present multiple times in SDP');c();return !1};e=e&&this._parseVersion(a);break;case 'o':if(null!==this.origin){al.log('Origin present multiple times in SDP');c();return !1};e=e&&this._parseOrigin(a);break;case 's':if(null!==this.sessionName){al.log('Session Name present multiple times in SDP');c();return !1};e=e&&this._parseSessionName(a);break;case 't':if(null!==this.timing){al.log('Timing present multiple times in SDP');c();return !1};e=e&&this._parseTiming(a);break;case 'm':null!==f&&this.sessionBlock!==f&&(this.media[f.type]=f);f={};f.rtpmap={};this._parseMediaDescription(a,f);break;case 'a':am._parseAttribute(a,f);break;default:al.log('Ignored unknown SDP directive: '+a);break};if(!e){c();return}}this.media[f.type]=f;e?b():c()})}_parseVersion(a){let b=a.match(/^v=([0-9]+)$/);if(!b||!b.length){al.log('\'v=\' (Version) formatted incorrectly: '+a);return !1}this.version=b[1];if(0!=this.version){al.log('Unsupported SDP version:'+this.version);return !1}return !0}_parseOrigin(a){let b=a.match(/^o=([^ ]+) (-?[0-9]+) (-?[0-9]+) (IN) (IP4|IP6) ([^ ]+)$/);if(!b||!b.length){al.log('\'o=\' (Origin) formatted incorrectly: '+a);return !1}this.origin={};this.origin.username=b[1];this.origin.sessionid=b[2];this.origin.sessionversion=b[3];this.origin.nettype=b[4];this.origin.addresstype=b[5];this.origin.unicastaddress=b[6];return !0}_parseSessionName(a){let b=a.match(/^s=([^\r\n]+)$/);if(!b||!b.length){al.log('\'s=\' (Session Name) formatted incorrectly: '+a);return !1}this.sessionName=b[1];return !0}_parseTiming(a){let b=a.match(/^t=([0-9]+) ([0-9]+)$/);if(!b||!b.length){al.log('\'t=\' (Timing) formatted incorrectly: '+a);return !1}this.timing={};this.timing.start=b[1];this.timing.stop=b[2];return !0}_parseMediaDescription(a,b){let c=a.match(/^m=([^ ]+) ([^ ]+) ([^ ]+)[ ]/);if(!c||!c.length){al.log('\'m=\' (Media) formatted incorrectly: '+a);return !1}b.type=c[1];b.port=c[2];b.proto=c[3];b.fmt=a.substr(c[0].length).split(' ').map(function(a,b,c){return parseInt(a)});for(let a of b.fmt)this.mediaMap[a]=b;return !0}static _parseAttribute(a,b){if(null===b){return !0}var c,d=a.indexOf(':'),e=a.substr(0,-1===d?0x7FFFFFFF:d);switch(e){case 'a=recvonly':;case 'a=sendrecv':;case 'a=sendonly':;case 'a=inactive':b.mode=a.substr(2);break;case 'a=range':c=a.match(/^a=range:\s*([a-zA-Z-]+)=([0-9.]+|now)\s*-\s*([0-9.]*)$/);b.range=[Number(c[2]=="now"?-1:c[2]),Number(c[3]),c[1]];break;case 'a=control':b.control=a.substr(10);break;case 'a=rtpmap':c=a.match(/^a=rtpmap:(\d+) (.*)$/);if(null===c){al.log('Could not parse \'rtpmap\' of \'a=\'');return !1};var i=parseInt(c[1]);b.rtpmap[i]={};var h=c[2].split('/');b.rtpmap[i].name=h[0].toUpperCase();b.rtpmap[i].clock=h[1];undefined!==h[2]&&(b.rtpmap[i].encparams=h[2]);b.ptype=af.string_map[h[0].toUpperCase()];break;case 'a=fmtp':c=a.match(/^a=fmtp:(\d+) (.*)$/);if(0===c.length){al.log('Could not parse \'fmtp\'  of \'a=\'');return !1};b.fmtp={};var g;for(g of c[2].split(';')){var f=g.indexOf('=');b.fmtp[g.substr(0,f).toLowerCase().trim()]=g.substr(f+1).trim()};break};return !0}getSessionBlock(){return this.sessionBlock}hasMedia(a){return this.media[a]!=undefined}getMediaBlock(a){return this.media[a]}getMediaBlockByPayloadType(a){return this.mediaMap[a]||null}getMediaBlockList(){var a=[],b;for(b in this.media)a.push(b);return a}}let an="rtsp:stream",ao=u(an);class ap{constructor(a,b){this.state=null;this.client=a;this.track=b;this.rtpChannel=1;this.stopKeepAlive();this.keepaliveInterval=null;this.keepaliveTime=30000}reset(){this.stopKeepAlive();this.client.forgetRTPChannel(this.rtpChannel);this.client=null;this.track=null}start(a = null){if(a!=null){return a.then(a=>this.sendSetup(a.session))}else{return this.sendSetup()}}stop(){return this.sendTeardown()}getSetupURL(a){let b=this.client.sdp.getSessionBlock();if(z.isAbsolute(a.control)){return a.control}else if(z.isAbsolute(`${b.control}${a.control}`)){return`${b.control}${a.control}`}else if(z.isAbsolute(`${this.client.contentBase}${a.control}`)){return`${this.client.contentBase}${a.control}`}else{return a.control};ao.error("Can't determine track URL from block.control:"+a.control+', '+'session.control:'+b.control+', and '+'content-base:'+this.client.contentBase)}getControlURL(){let a=this.client.sdp.getSessionBlock().control;if(z.isAbsolute(a)){return a}else if(!a||'*'===a){return this.client.contentBase}else{return`${this.client.contentBase}${a}`}}sendKeepalive(){if(this.client.methods.includes('GET_PARAMETER')){return this.client.sendRequest('GET_PARAMETER',this.getSetupURL(this.track),{'Session':this.session})}else{return this.client.sendRequest('OPTIONS','*')}}stopKeepAlive(){clearInterval(this.keepaliveInterval)}startKeepAlive(){this.keepaliveInterval=setInterval(()=>{this.sendKeepalive().catch(a=>{ao.error(a);if(a instanceof bb){if(Number(a.data.parsed.code)==501){return}}this.client.reconnect()})},this.keepaliveTime)}sendRequest(a,b = {}){let c={};this.session&&(c.Session=this.session);Object.assign(c,b);return this.client.sendRequest(a,this.getControlURL(),c)}sendSetup(a = null){this.state=bc.STATE_SETUP;this.rtpChannel=this.client.interleaveChannelIndex;let b=this.client.interleaveChannelIndex+++"-"+this.client.interleaveChannelIndex++,c={'Transport':`RTP/AVP/TCP;unicast;interleaved=${b}`,'Date':new Date().toUTCString()};a&&(c.Session=a);return this.client.sendRequest('SETUP',this.getSetupURL(this.track),c).then(a=>{this.session=a.headers.session;let b=a.headers.transport;if(b){let a=b.match(/interleaved=([0-9]+)-([0-9]+)/)[1];a&&(this.rtpChannel=Number(a))}let c=this.session.split(';').slice(1),d={};for(let a of c){let b=a.split('=');d[b[0]]=b[1]}d.timeout&&(this.keepaliveInterval=Number(d.timeout)*500);this.client.useRTPChannel(this.rtpChannel);this.startKeepAlive();return{track:this.track,data:a,session:this.session}})}}function aq(a,b){var c=(a&0xFFFF)+(b&0xFFFF),d=(a>>16)+(b>>16)+(c>>16);return d<<16|c&0xFFFF}function ar(a,b){return a<<b|a>>>32-b}function as(a,b,c,d,e,f){return aq(ar(aq(aq(b,a),aq(d,f)),e),c)}function at(a,b,c,d,e,f,g){return as(b&c|~b&d,a,b,e,f,g)}function au(a,b,c,d,e,f,g){return as(b&d|c&~d,a,b,e,f,g)}function av(a,b,c,d,e,f,g){return as(b^c^d,a,b,e,f,g)}function aw(a,b,c,d,e,f,g){return as(c^(b|~d),a,b,e,f,g)}function ax(a,b){a[b>>5]|=0x80<<b%32;a[(b+64>>>9<<4)+14]=b;var c,d,e,f,g,h=1732584193,i=-271733879,j=-1732584194,k=271733878;for(c=0;c<a.length;c+=16)d=h,e=i,f=j,g=k,h=at(h,i,j,k,a[c],7,-680876936),k=at(k,h,i,j,a[c+1],12,-389564586),j=at(j,k,h,i,a[c+2],17,606105819),i=at(i,j,k,h,a[c+3],22,-1044525330),h=at(h,i,j,k,a[c+4],7,-176418897),k=at(k,h,i,j,a[c+5],12,1200080426),j=at(j,k,h,i,a[c+6],17,-1473231341),i=at(i,j,k,h,a[c+7],22,-45705983),h=at(h,i,j,k,a[c+8],7,1770035416),k=at(k,h,i,j,a[c+9],12,-1958414417),j=at(j,k,h,i,a[c+10],17,-42063),i=at(i,j,k,h,a[c+11],22,-1990404162),h=at(h,i,j,k,a[c+12],7,1804603682),k=at(k,h,i,j,a[c+13],12,-40341101),j=at(j,k,h,i,a[c+14],17,-1502002290),i=at(i,j,k,h,a[c+15],22,1236535329),h=au(h,i,j,k,a[c+1],5,-165796510),k=au(k,h,i,j,a[c+6],9,-1069501632),j=au(j,k,h,i,a[c+11],14,643717713),i=au(i,j,k,h,a[c],20,-373897302),h=au(h,i,j,k,a[c+5],5,-701558691),k=au(k,h,i,j,a[c+10],9,38016083),j=au(j,k,h,i,a[c+15],14,-660478335),i=au(i,j,k,h,a[c+4],20,-405537848),h=au(h,i,j,k,a[c+9],5,568446438),k=au(k,h,i,j,a[c+14],9,-1019803690),j=au(j,k,h,i,a[c+3],14,-187363961),i=au(i,j,k,h,a[c+8],20,1163531501),h=au(h,i,j,k,a[c+13],5,-1444681467),k=au(k,h,i,j,a[c+2],9,-51403784),j=au(j,k,h,i,a[c+7],14,1735328473),i=au(i,j,k,h,a[c+12],20,-1926607734),h=av(h,i,j,k,a[c+5],4,-378558),k=av(k,h,i,j,a[c+8],11,-2022574463),j=av(j,k,h,i,a[c+11],16,1839030562),i=av(i,j,k,h,a[c+14],23,-35309556),h=av(h,i,j,k,a[c+1],4,-1530992060),k=av(k,h,i,j,a[c+4],11,1272893353),j=av(j,k,h,i,a[c+7],16,-155497632),i=av(i,j,k,h,a[c+10],23,-1094730640),h=av(h,i,j,k,a[c+13],4,681279174),k=av(k,h,i,j,a[c],11,-358537222),j=av(j,k,h,i,a[c+3],16,-722521979),i=av(i,j,k,h,a[c+6],23,76029189),h=av(h,i,j,k,a[c+9],4,-640364487),k=av(k,h,i,j,a[c+12],11,-421815835),j=av(j,k,h,i,a[c+15],16,530742520),i=av(i,j,k,h,a[c+2],23,-995338651),h=aw(h,i,j,k,a[c],6,-198630844),k=aw(k,h,i,j,a[c+7],10,1126891415),j=aw(j,k,h,i,a[c+14],15,-1416354905),i=aw(i,j,k,h,a[c+5],21,-57434055),h=aw(h,i,j,k,a[c+12],6,1700485571),k=aw(k,h,i,j,a[c+3],10,-1894986606),j=aw(j,k,h,i,a[c+10],15,-1051523),i=aw(i,j,k,h,a[c+1],21,-2054922799),h=aw(h,i,j,k,a[c+8],6,1873313359),k=aw(k,h,i,j,a[c+15],10,-30611744),j=aw(j,k,h,i,a[c+6],15,-1560198380),i=aw(i,j,k,h,a[c+13],21,1309151649),h=aw(h,i,j,k,a[c+4],6,-145523070),k=aw(k,h,i,j,a[c+11],10,-1120210379),j=aw(j,k,h,i,a[c+2],15,718787259),i=aw(i,j,k,h,a[c+9],21,-343485551),h=aq(h,d),i=aq(i,e),j=aq(j,f),k=aq(k,g);return[h,i,j,k]}function ay(a){var b,c='',d=a.length*32;for(b=0;b<d;b+=8)c+=String.fromCharCode(a[b>>5]>>>b%32&0xFF);return c}function az(a){var b,c=[];c[(a.length>>2)-1]=undefined;for(b=0;b<c.length;b+=1)c[b]=0;var d=a.length*8;for(b=0;b<d;b+=8)c[b>>5]|=(a.charCodeAt(b/8)&0xFF)<<b%32;return c}function aA(a){return ay(ax(az(a),a.length*8))}function aB(a,b){var c,d=az(a),e=[],f=[],g;e[15]=f[15]=undefined;d.length>16&&(d=ax(d,a.length*8));for(c=0;c<16;c+=1)e[c]=d[c]^0x36363636,f[c]=d[c]^0x5C5C5C5C;g=ax(e.concat(az(b)),512+b.length*8);return ay(ax(f.concat(g),640))}function aC(a){var b='0123456789abcdef',c='',d,e;for(e=0;e<a.length;e+=1)d=a.charCodeAt(e),c+=b.charAt(d>>>4&0x0F)+b.charAt(d&0x0F);return c}function aD(a){return unescape(encodeURIComponent(a))}function aE(a){return aA(aD(a))}function aF(a){return aC(aE(a))}function aG(a,b){return aB(aD(a),aD(b))}function aH(a,b){return aC(aG(a,b))}function aI(a,b,c){if(!b){if(!c){return aF(a)}return aE(a)}if(!c){return aH(b,a)}return aG(b,a)}class aJ{constructor(a,b){let c=new DataView(a.buffer,a.byteOffset,a.byteLength);this.version=c.getUint8(0)>>>6;this.padding=c.getUint8(0)&1;this.has_extension=c.getUint8(0)&1;this.csrc=c.getUint8(0)&0x0F;this.marker=c.getUint8(1)>>>7;this.pt=c.getUint8(1)&0x7F;this.sequence=c.getUint16(2) ;this.timestamp=c.getUint32(4);this.ssrc=c.getUint32(8);this.csrcs=[];let d=12;this.csrc>0&&(this.csrcs.push(c.getUint32(d)),d+=4);this.has_extension==1&&(this.extension=c.getUint16(d),this.ehl=c.getUint16(d+2),d+=4,this.header_data=a.slice(d,this.ehl),d+=this.ehl);this.headerLength=d;let e=0;this.padding&&(e=c.getUint8(a.byteLength-1));this.media=b.getMediaBlockByPayloadType(this.pt);null===this.media?v.log(`Media description for payload type: ${this.pt} not provided.`):(this.type=this.media.ptype);this.data=a.subarray(d)}getPayload(){return this.data}getTimestampMS(){return this.timestamp}toString(){return"RTP(version:"+this.version+", "+"padding:"+this.padding+", "+"has_extension:"+this.has_extension+", "+"csrc:"+this.csrc+", "+"marker:"+this.marker+", "+"pt:"+this.pt+", "+"sequence:"+this.sequence+", "+"timestamp:"+this.timestamp+", "+"ssrc:"+this.ssrc+")"}isVideo(){return this.media.type=='video'}isAudio(){return this.media.type=='audio'}}class aK{constructor(a){this.tsOffsets={};for(let b in a.media){for(let c of a.media[b].fmt)this.tsOffsets[c]={last:0,overflow:0}}}build(a,b){let c=new aJ(a,b),d=this.tsOffsets[c.pt];d&&(c.timestamp+=d.overflow,d.last&&Math.abs(c.timestamp-d.last)>0x7fffffff&&(console.log(`\nlast ts: ${d.last}\n
                            new ts: ${c.timestamp}\n
                            new ts adjusted: ${c.timestamp+0xffffffff}\n
                            last overflow: ${d.overflow}\n
                            new overflow: ${d.overflow+0xffffffff}\n
                            `),d.overflow+=0xffffffff,c.timestamp+=0xffffffff),d.last=c.timestamp);return c}}class aL{static get RTSP_1_0(){return"RTSP/1.0"}constructor(a){this.version=a}build(a,b,c={},d=null){let e=`${a} ${b} ${this.version}\r\n`;for(let a in c)e+=`${a}: ${c[a]}\r\n`;d&&(e+=`Content-Length: ${d.length}\r\n`);e+='\r\n';d&&(e+=d);return e}parse(a){let b=a.split('\r\n'),c={headers:{},body:null,code:0,statusLine:''},d;[d,c.code,c.statusLine]=b[0].match(new RegExp(`${this.version}[ ]+([0-9]{3})[ ]+(.*)`));c.code=Number(c.code);let e=1;while(b[e]){let[a,d]=b[e].split(/:(.+)/);c.headers[a.toLowerCase()]=d.trim();e++}c.body=b.slice(e).join('\n\r');return c}}let aM=new aL(aL.RTSP_1_0);class aN{constructor(){this.fragmented_nalu=null}static parseNALHeader(a){return{nri:a&0x60,type:a&0x1F}}parseSingleNALUPacket(a,b,c,d){return new aa(b.type,b.nri,a.subarray(0),c,d)}parseAggregationPacket(a,b,c,d){let e=new DataView(a.buffer,a.byteOffset,a.byteLength),f=0,g=null;aa.STAP_B===b.type&&(g=e.getUint16(f),f+=2);let h=[];while(f<e.byteLength){let b=e.getUint16(f);f+=2;let g=aN.parseNALHeader(e.getInt8(f));f++;let i=this.parseSingleNALUPacket(a.subarray(f,f+b),g,c,d);i!==null&&h.push(i);f+=b}return h}parseFragmentationUnit(a,b,c,d){let e=new DataView(a.buffer,a.byteOffset,a.byteLength),f=0,g=e.getUint8(f),h=(g&0x80)>>>7,i=(g&0x40)>>>6,j=g&0x1F,k=null;f++;let l=0;aa.FU_B===b.type&&(l=e.getUint16(f),f+=2);h&&(this.fragmented_nalu=new aa(j,b.nri,a.subarray(f),c,d));if(this.fragmented_nalu&&this.fragmented_nalu.ntype===j){h||this.fragmented_nalu.appendData(a.subarray(f));if(i){k=this.fragmented_nalu;this.fragmented_nalu=null;return k}}return null}onNALUFragment(a,b,c){let d=new DataView(a.buffer,a.byteOffset,a.byteLength),e=aN.parseNALHeader(d.getUint8(0)),f=1,g=null;if(e.type>0&&e.type<24)g=this.parseSingleNALUPacket(a.subarray(f),e,b,c);else if(aa.FU_A===e.type||aa.FU_B===e.type)g=this.parseFragmentationUnit(a.subarray(f),e,b,c);else if(aa.STAP_A===e.type||aa.STAP_B===e.type){return this.parseAggregationPacket(a.subarray(f),e,b,c)}else{v.log('Undefined NAL unit, type: '+e.type);return null};if(g){return[g]}return null}}class aO{constructor(a,b,c){this.dts=b;this.pts=c?c:this.dts;this.data=a}getData(){return this.data}getSize(){return this.data.byteLength}}class aP{constructor(){this.config=null}onAACFragment(a){let b=a.getPayload();if(!a.media){return null}let c=new DataView(b.buffer,b.byteOffset,b.byteLength),d=Number(a.media.fmtp.sizelength||0),e=Number(a.media.fmtp.indexlength||0),f=Number(a.media.fmtp.indexdeltalength||0),g=Number(a.media.fmtp.ctsdeltalength||0),h=Number(a.media.fmtp.dtsdeltalength||0),i=Number(a.media.fmtp.randomaccessindication||0),j=Number(a.media.fmtp.streamstateindication||0),k=Number(a.media.fmtp.auxiliarydatasizelength||0),l=d+Math.max(e,f)+g+h+i+j+k,m=0,n=0,o=(Math.round(a.getTimestampMS()/1024)<<10)*90000/this.config.samplerate;if(0!==l){let a=c.getUint16(0);m=2+(a>>>3)+(a&0x7?1:0);let k=[],l=0,p=new $(b.subarray(2+n)),q=0,r=0;for(let c=0;c<a;){let n=p.readBits(d);c+=d+(c?f:e)/*+2*/;if(g){q=p.readBits(g),c+=g}if(h){r=p.readBits(h),c+=g}i&&(p.skipBits(1),c+=1);j&&(p.skipBits(j),c+=j);k.push(new aO(b.subarray(m+l,m+l+n),o+r,o+q));l+=n}return k}else{let a=b.subarray(m);while(!0){if(a[n]!=255)break;++n}++n;return[new aO(b.subarray(m+n),o)]}}}class aQ{constructor(){this.h264parser=new aR();this.aacparser=new aS()}parse(a){if(a.media.type=='video'){return this.h264parser.parse(a)}else if(a.media.type=='audio'){return this.aacparser.parse(a)};return null}}class aR{constructor(){this.naluasm=new aN()}parse(a){return this.naluasm.onNALUFragment(a.getPayload(),a.getTimestampMS())}}class aS{constructor(){this.scale=1;this.asm=new aP()}setConfig(a){this.asm.config=a}parse(a){return this.asm.onAACFragment(a)}}class aT{constructor(a={flush:100}){this.options=a;this.eventSource=new H();Object.defineProperties(this,{sourceUrl:{value:null,writable:!0},paused:{value:!0,writable:!0},seekable:{value:!1,writable:!0},connected:{value:!1,writable:!0}});this._onData=()=>{if(this.connected){while(this.transport.dataQueue.length)this.onData(this.transport.dataQueue.pop())}};this._onConnect=this.onConnected.bind(this);this._onDisconnect=this.onDisconnected.bind(this)}static streamType(){return null}destroy(){this.detachTransport()}attachTransport(a){this.transport&&this.detachTransport();this.transport=a;this.transport.eventSource.addEventListener('data',this._onData);this.transport.eventSource.addEventListener('connected',this._onConnect);this.transport.eventSource.addEventListener('disconnected',this._onDisconnect)}detachTransport(){this.transport&&(this.transport.eventSource.removeEventListener('data',this._onData),this.transport.eventSource.removeEventListener('connected',this._onConnect),this.transport.eventSource.removeEventListener('disconnected',this._onDisconnect),this.transport=null)}reset(){}start(){v.log('Client started');this.paused=!1}stop(){v.log('Client paused');this.paused=!0}seek(a){}setSource(a){this.stop();this.endpoint=a;this.sourceUrl=a.urlpath}startStreamFlush(){this.flushInterval=setInterval(()=>{this.paused||this.eventSource.dispatchEvent('flush')},this.options.flush)}stopStreamFlush(){clearInterval(this.flushInterval)}onData(a){}onConnected(){this.seekable||(this.transport.dataQueue=[],this.eventSource.dispatchEvent('clear'));this.connected=!0}onDisconnected(){this.connected=!1}queryCredentials(){return Promise.resolve()}setCredentials(a,b){this.endpoint.user=a;this.endpoint.pass=b;this.endpoint.auth=`${a}:${b}`}}class aU{static get SampleRates(){return[96000,88200,64000,48000,44100,32000,24000,22050,16000,12000,11025,8000,7350]}static parseAudioSpecificConfig(a){let b;a.byteLength?(b=new $(a)):(b=a);let c=b.bitpos+(b.src.byteOffset+b.bytepos)*8,d=b.readBits(5);this.codec=`mp4a.40.${d}`;let e=b.readBits(4);e==0xf&&b.skipBits(24);let f=b.readBits(4);return{config:_(new Uint8Array(b.src.buffer),c,c+16),codec:`mp4a.40.${d}`,samplerate:aU.SampleRates[e],channels:f}}static parseStreamMuxConfig(a){let b=new $(a);if(!b.readBits(1)){b.skipBits(14);return aU.parseAudioSpecificConfig(b)}}}let aV="rtsp:session",aW=u(aV);class aX{constructor(a,b){this.state=null;this.client=a;this.sessionId=b;this.url=this.getControlURL()}reset(){this.client=null}start(){return this.sendPlay()}stop(){return this.sendTeardown()}getControlURL(){let a=this.client.sdp.getSessionBlock().control;if(z.isAbsolute(a)){return a}else if(!a||'*'===a){return this.client.contentBase}else{return`${this.client.contentBase}${a}`}}sendRequest(a,b = {}){let c={};this.sessionId&&(c.Session=this.sessionId);Object.assign(c,b);return this.client.sendRequest(a,this.getControlURL(),c)}async sendPlay(a = 0){this.state=bc.STATE_PLAY;let b={},c=this.client.sdp.sessionBlock.range;c&&(c[0]==-1&&(c[0]=0));let d=await this.sendRequest('PLAY',b);this.state=bc.STATE_PLAYING;return{data:d}}async sendPause(){if(!this.client.supports("PAUSE")){return}this.state=bc.STATE_PAUSE;await this.sendRequest("PAUSE");this.state=bc.STATE_PAUSED}async sendTeardown(){this.state!=bc.STATE_TEARDOWN&&(this.state=bc.STATE_TEARDOWN,await this.sendRequest("TEARDOWN"),aW.log('RTSPClient: STATE_TEARDOWN'))}}let aY="client:rtsp",aZ=u(aY);class a_ extends aT{constructor(a={flush:200}){super(a);this.clientSM=new bc(this);this.clientSM.ontracks=a=>{this.eventSource.dispatchEvent('tracks',a);this.startStreamFlush()};this.sampleQueues={}}static streamType(){return'rtsp'}setSource(a){super.setSource(a);this.clientSM.setSource(a)}attachTransport(a){super.attachTransport(a);this.clientSM.transport=a}detachTransport(){super.detachTransport();this.clientSM.transport=null}reset(){super.reset();this.sampleQueues={}}destroy(){this.clientSM.destroy();return super.destroy()}start(){super.start();if(this.transport){return this.transport.ready.then(()=>{return this.clientSM.start()})}else{return Promise.reject("no transport attached")}}stop(){super.stop();return this.clientSM.stop()}onData(a){this.clientSM.onData(a)}onConnected(){this.clientSM.onConnected();super.onConnected()}onDisconnected(){super.onDisconnected();this.clientSM.onDisconnected()}}class a$ extends Error{constructor(a){super(a)}}class bb extends Error{constructor(a){super(a.msg);this.data=a}}class bc extends ak{static get USER_AGENT(){return'SFRtsp 0.3'}static get STATE_INITIAL(){return 1}static get STATE_OPTIONS(){return 2}static get STATE_DESCRIBE(){return 4}static get STATE_SETUP(){return 8}static get STATE_STREAMS(){return 16}static get STATE_TEARDOWN(){return 32}static get STATE_PLAY(){return 64}static get STATE_PLAYING(){return 128}static get STATE_PAUSE(){return 256}static get STATE_PAUSED(){return 512}constructor(a){super();this.parent=a;this.transport=null;this.payParser=new aQ();this.rtp_channels=new Set();this.sessions={};this.ontracks=null;this.addState(bc.STATE_INITIAL,{}).addState(bc.STATE_OPTIONS,{activate:this.sendOptions,finishTransition:this.onOptions}).addState(bc.STATE_DESCRIBE,{activate:this.sendDescribe,finishTransition:this.onDescribe}).addState(bc.STATE_SETUP,{activate:this.sendSetup,finishTransition:this.onSetup}).addState(bc.STATE_STREAMS,{}).addState(bc.STATE_TEARDOWN,{activate:()=>{this.started=!1},finishTransition:()=>{return this.transitionTo(bc.STATE_INITIAL)}}).addTransition(bc.STATE_INITIAL,bc.STATE_OPTIONS).addTransition(bc.STATE_INITIAL,bc.STATE_TEARDOWN).addTransition(bc.STATE_OPTIONS,bc.STATE_DESCRIBE).addTransition(bc.STATE_DESCRIBE,bc.STATE_SETUP).addTransition(bc.STATE_SETUP,bc.STATE_STREAMS).addTransition(bc.STATE_TEARDOWN,bc.STATE_INITIAL).addTransition(bc.STATE_STREAMS,bc.STATE_TEARDOWN).addTransition(bc.STATE_SETUP,bc.STATE_TEARDOWN).addTransition(bc.STATE_DESCRIBE,bc.STATE_TEARDOWN).addTransition(bc.STATE_OPTIONS,bc.STATE_TEARDOWN);this.reset();this.shouldReconnect=!1}destroy(){this.parent=null}setSource(a){this.reset();this.endpoint=a;this.url=`${a.protocol}://${a.location}${a.urlpath}`}onConnected(){this.rtpFactory&&(this.rtpFactory=null);this.shouldReconnect&&this.start()}async onDisconnected(){this.reset();this.shouldReconnect=!0;await this.transitionTo(bc.STATE_TEARDOWN);await this.transitionTo(bc.STATE_INITIAL)}start(){if(this.currentState.name!==bc.STATE_STREAMS){return this.transitionTo(bc.STATE_OPTIONS)}else{let a=[];for(let b in this.sessions)a.push(this.sessions[b].sendPlay());return Promise.all(a)}}onData(a){let b=a[1];this.rtp_channels.has(b)&&this.onRTP({packet:a.subarray(4),type:b})}useRTPChannel(a){this.rtp_channels.add(a)}forgetRTPChannel(a){this.rtp_channels.delete(a)}stop(){this.shouldReconnect=!1;let a=[];for(let b in this.sessions)a.push(this.sessions[b].sendPause());return Promise.all(a)}async reset(){this.authenticator='';this.methods=[];this.tracks=[];this.rtpBuffer={};for(let a in this.streams)this.streams[a].reset();for(let a in this.sessions)this.sessions[a].reset();this.streams={};this.sessions={};this.contentBase="";this.currentState?(this.currentState.name!=bc.STATE_INITIAL&&(await this.transitionTo(bc.STATE_TEARDOWN),await this.transitionTo(bc.STATE_INITIAL))):(await this.transitionTo(bc.STATE_INITIAL));this.sdp=null;this.interleaveChannelIndex=0;this.session=null;this.timeOffset={};this.lastTimestamp={}}async reconnect(){await this.reset();if(this.currentState.name!=bc.STATE_INITIAL){await this.transitionTo(bc.STATE_TEARDOWN);return this.transitionTo(bc.STATE_OPTIONS)}else{return this.transitionTo(bc.STATE_OPTIONS)}}supports(a){return this.methods.includes(a)}parse(a){aZ.debug(a.payload);let b=a.payload.split('\r\n\r\n'),c=aM.parse(b[0]),d=Number(c.headers['content-length']);if(d){let b=a.payload.split('\r\n\r\n');c.body=b[1]}else c.body="";return c}sendRequest(a,b,c={},d=null){this.cSeq++;Object.assign(c,{CSeq:this.cSeq,'User-Agent':bc.USER_AGENT});this.authenticator&&(c.Authorization=this.authenticator(a));return this.send(aM.build(a,b,c,d),a).catch(e=>{if(e instanceof a$&&!c.Authorization){return this.sendRequest(a,b,c,d)}else{throw e}})}async send(a,b){if(this.transport){try{await this.transport.ready}catch(a){this.onDisconnected();throw a};aZ.debug(a);let b=await this.transport.send(a),c=this.parse(b);if(c.code==401){aZ.debug(c.headers['www-authenticate']);let a=c.headers['www-authenticate'],b=a.substring(0,a.indexOf(' '));a=a.substr(b.length+1);let d=a.split(','),f=this.parent.endpoint;if(!f.user||!f.pass){try{await this.parent.queryCredentials.call(this.parent)}catch(a){throw new a$()}}if(b.toLowerCase()=='digest'){let a={};for(let b of d){let c=b.trim(),[e,f]=c.split('=');a[e]=f.substr(1,f.length-2)}this.authenticator=b=>{let c=this.parent.endpoint,d=aI(`${c.user}:${a.realm}:${c.pass}`),e=aI(`${b}:${this.url}`),f=aI(`${d}:${a.nonce}:${e}`),g='';return`Digest username="${c.user}", realm="${a.realm}", nonce="${a.nonce}", uri="${this.url}", response="${f}"${g}`}}else this.authenticator=()=>{return`Basic ${btoa(this.parent.endpoint.auth)}`};throw new a$(c)}if(c.code>=300){aZ.error(c.statusLine);throw new bb({msg:`RTSP error: ${c.code} ${c.statusLine}`,parsed:c})}return c}else{return Promise.reject("No transport attached")}}sendOptions(){this.reset();this.started=!0;this.cSeq=0;return this.sendRequest('OPTIONS','*',{})}onOptions(a){this.methods=a.headers['public'].split(',').map(a=>a.trim());this.transitionTo(bc.STATE_DESCRIBE)}sendDescribe(){return this.sendRequest('DESCRIBE',this.url,{'Accept':'application/sdp'}).then(a=>{this.sdp=new am();return this.sdp.parse(a.body).catch(()=>{throw new Error("Failed to parse SDP")}).then(()=>{return a})})}onDescribe(a){this.contentBase=a.headers['content-base']||this.url;this.tracks=this.sdp.getMediaBlockList();this.rtpFactory=new aK(this.sdp);aZ.log('SDP contained '+this.tracks.length+' track(s). Calling SETUP for each.');a.headers.session&&(this.session=a.headers.session);if(!this.tracks.length){throw new Error("No tracks in SDP")}this.transitionTo(bc.STATE_SETUP)}sendSetup(){let a=[],b=null;for(let c of this.tracks){aZ.log("setup track: "+c);let d=this.sdp.getMediaBlock(c);if(!af.string_map[d.rtpmap[d.fmt[0]].name])continue;this.streams[c]=new ap(this,d);let f=this.streams[c].start(b);b=f;this.parent.sampleQueues[af.string_map[d.rtpmap[d.fmt[0]].name]]=[];this.rtpBuffer[d.fmt[0]]=[];a.push(f.then(({track:a,data:b})=>{this.timeOffset[a.fmt[0]]=0;try{let c=b.headers["rtp-info"].split(';');for(let b of c){let[d,e]=b.split("=");d==="rtptime"&&(this.timeOffset[a.fmt[0]]=0)}}catch(a){};let c={timescale:0,scaleFactor:0};if(a.fmtp['sprop-parameter-sets']){let b=a.fmtp['sprop-parameter-sets'].split(',');c={sps:Y(b[0]),pps:Y(b[1])}}else if(a.fmtp.config){let b=a.fmtp.config;this.has_config=a.fmtp.cpresent!='0';let d=a.rtpmap[a.fmt[0]].name=='MPEG4-GENERIC';d?(c={config:aU.parseAudioSpecificConfig(Z(b))},this.payParser.aacparser.setConfig(c.config)):b&&(c={config:aU.parseStreamMuxConfig(Z(b))},this.payParser.aacparser.setConfig(c.config))};c.duration=this.sdp.sessionBlock.range?this.sdp.sessionBlock.range[1]-this.sdp.sessionBlock.range[0]:1;this.parent.seekable=c.duration>1;let d={track:a,offset:this.timeOffset[a.fmt[0]],type:af.string_map[a.rtpmap[a.fmt[0]].name],params:c,duration:c.duration};console.log(d,this.timeOffset);let f=b.headers.session.split(';')[0];this.sessions[f]||(this.sessions[f]=new aX(this,f));return d}))}return Promise.all(a).then(a=>{let b=[];for(let a in this.sessions)b.push(this.sessions[a].start());return Promise.all(b).then(()=>{this.ontracks&&this.ontracks(a)})}).catch(a=>{console.error(a);this.stop();this.reset()})}onSetup(){this.transitionTo(bc.STATE_STREAMS)}onRTP(a){if(!this.rtpFactory)return;let b=this.rtpFactory.build(a.packet,this.sdp);if(!b.type){return}if(this.timeOffset[b.pt]===undefined){this.rtpBuffer[b.pt].push(b);return}this.lastTimestamp[b.pt]===undefined&&(this.lastTimestamp[b.pt]=b.timestamp-this.timeOffset[b.pt]);let c=this.rtpBuffer[b.pt];c.push(b);while(c.length){let a=c.shift();a.timestamp=a.timestamp-this.timeOffset[a.pt]-this.lastTimestamp[a.pt];if(a.media){let b=this.payParser.parse(a);b&&this.parent.sampleQueues[a.type].push(b)}}}}var bd=100,be="\u2026",bf={tag:function(a,b){var c=document.createElement(a);c.className=b;return c},text:function(a){return document.createTextNode(a)}};class bg{static get hexDigits(){return"0123456789ABCDEF"}static get reTime(){return /^((?:1[89]|2\d)?\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/}constructor(a,b){a instanceof bg?(this.enc=a.enc,this.pos=a.pos):(this.enc=a,this.pos=b)}get(a){a===undefined&&(a=this.pos++);if(a>=this.enc.length)throw 'Requesting byte offset '+a+' on a stream of length '+this.enc.length;return this.enc[a]}hexByte(a){return bg.hexDigits.charAt(a>>4&0xF)+bg.hexDigits.charAt(a&0xF)}hexDump(a,b,c){var d="";for(var e=a;e<b;++e){d+=this.hexByte(this.get(e));if(c!==!0)switch(e&0xF){case 0x7:d+="  ";break;case 0xF:d+="\n";break;default:d+=" "}}return d}parseStringISO(a,b){var c="";for(var d=a;d<b;++d)c+=String.fromCharCode(this.get(d));return c}parseStringUTF(a,b){var c="";for(var d=a;d<b;){var e=this.get(d++);e<128?(c+=String.fromCharCode(e)):e>191&&e<224?(c+=String.fromCharCode((e&0x1F)<<6|this.get(d++)&0x3F)):(c+=String.fromCharCode((e&0x0F)<<12|(this.get(d++)&0x3F)<<6|this.get(d++)&0x3F))}return c}parseStringBMP(a,b){var c="";for(var d=a;d<b;d+=2){var e=this.get(d),f=this.get(d+1);c+=String.fromCharCode((e<<8)+f)}return c}parseTime(a,b){var c=this.parseStringISO(a,b),d=bg.reTime.exec(c);if(!d)return"Unrecognized time: "+c;c=d[1]+"-"+d[2]+"-"+d[3]+" "+d[4];d[5]&&(c+=":"+d[5],d[6]&&(c+=":"+d[6],d[7]&&(c+="."+d[7])));d[8]&&(c+=" UTC",d[8]!='Z'&&(c+=d[8],d[9]&&(c+=":"+d[9])));return c}parseInteger(a,b){var c=b-a;if(c>4){c<<=3;var d=this.get(a);if(d===0)c-=8;else while(d<128)d<<=1,--c;return"("+c+" bit)"}var e=0;for(var f=a;f<b;++f)e=e<<8|this.get(f);return e}parseBitString(a,b){var c=this.get(a),d=(b-a-1<<3)-c,e="("+d+" bit)";if(d<=20){var f=c;e+=" ";for(var g=b-1;g>a;--g){var h=this.get(g);for(var i=f;i<8;++i)e+=h>>i&1?"1":"0";f=0}}return e}parseOctetString(a,b){var c=b-a,d="("+c+" byte) ";c>bd&&(b=a+bd);for(var e=a;e<b;++e)d+=this.hexByte(this.get(e));c>bd&&(d+=be);return d}parseOID(a,b){var c='',d=0,e=0;for(var f=a;f<b;++f){var g=this.get(f);d=d<<7|g&0x7F;e+=7;if(!(g&0x80)){if(c===''){var h=d<80?d<40?0:1:2;c=h+"."+(d-h*40)}else c+="."+(e>=31?"bigint":d);d=e=0}}return c}}class bh{static get reSeemsASCII(){return /^[ -~]+$/}constructor(a,b,c,d,e){this.stream=a;this.header=b;this.length=c;this.tag=d;this.sub=e}typeName(){if(this.tag===undefined)return"unknown";var a=this.tag>>6,c=this.tag&0x1F;switch(a){case 0:switch(c){case 0x00:return"EOC";case 0x01:return"BOOLEAN";case 0x02:return"INTEGER";case 0x03:return"BIT_STRING";case 0x04:return"OCTET_STRING";case 0x05:return"NULL";case 0x06:return"OBJECT_IDENTIFIER";case 0x07:return"ObjectDescriptor";case 0x08:return"EXTERNAL";case 0x09:return"REAL";case 0x0A:return"ENUMERATED";case 0x0B:return"EMBEDDED_PDV";case 0x0C:return"UTF8String";case 0x10:return"SEQUENCE";case 0x11:return"SET";case 0x12:return"NumericString";case 0x13:return"PrintableString";case 0x14:return"TeletexString";case 0x15:return"VideotexString";case 0x16:return"IA5String";case 0x17:return"UTCTime";case 0x18:return"GeneralizedTime";case 0x19:return"GraphicString";case 0x1A:return"VisibleString";case 0x1B:return"GeneralString";case 0x1C:return"UniversalString";case 0x1E:return"BMPString";default:return"Universal_"+c.toString(16)};case 1:return"Application_"+c.toString(16);case 2:return"["+c+"]";case 3:return"Private_"+c.toString(16)}}content(){if(this.tag===undefined)return null;var a=this.tag>>6,b=this.tag&0x1F,c=this.posContent(),d=Math.abs(this.length);if(a!==0){if(this.sub!==null)return"("+this.sub.length+" elem)";var e=this.stream.parseStringISO(c,c+Math.min(d,bd));if(bh.reSeemsASCII.test(e))return e.substring(0,2*bd)+(e.length>2*bd?be:"");else return this.stream.parseOctetString(c,c+d)}switch(b){case 0x01:return this.stream.get(c)===0?"false":"true";case 0x02:return this.stream.parseInteger(c,c+d);case 0x03:return this.sub?"("+this.sub.length+" elem)":this.stream.parseBitString(c,c+d);case 0x04:return this.sub?"("+this.sub.length+" elem)":this.stream.parseOctetString(c,c+d);case 0x06:return this.stream.parseOID(c,c+d);case 0x10:;case 0x11:return"("+this.sub.length+" elem)";case 0x0C:return this.stream.parseStringUTF(c,c+d);case 0x12:;case 0x13:;case 0x14:;case 0x15:;case 0x16:;case 0x1A:return this.stream.parseStringISO(c,c+d);case 0x1E:return this.stream.parseStringBMP(c,c+d);case 0x17:;case 0x18:return this.stream.parseTime(c,c+d)};return null}toString(){return this.typeName()+"@"+this.stream.pos+"[header:"+this.header+",length:"+this.length+",sub:"+(this.sub===null?'null':this.sub.length)+"]"}print(a){a===undefined&&(a='');document.writeln(a+this);if(this.sub!==null){a+='  ';for(var b=0,c=this.sub.length;b<c;++b)this.sub[b].print(a)}}toPrettyString(a){a===undefined&&(a='');var b=a+this.typeName()+" @"+this.stream.pos;this.length>=0&&(b+="+");b+=this.length;this.tag&0x20?(b+=" (constructed)"):(this.tag==0x03||this.tag==0x04)&&this.sub!==null&&(b+=" (encapsulates)");b+="\n";if(this.sub!==null){a+='  ';for(var c=0,d=this.sub.length;c<d;++c)b+=this.sub[c].toPrettyString(a)}return b}toDOM(){var a=bf.tag("div","node");a.asn1=this;var b=bf.tag("div","head"),c=this.typeName().replace(/_/g," ");b.innerHTML=c;var d=this.content();if(d!==null){d=String(d).replace(/</g,"&lt;");var e=bf.tag("span","preview");e.appendChild(bf.text(d));b.appendChild(e)}a.appendChild(b);this.node=a;this.head=b;var f=bf.tag("div","value");c="Offset: "+this.stream.pos+"<br/>";c+="Length: "+this.header+"+";this.length>=0?(c+=this.length):(c+=-this.length+" (undefined)");this.tag&0x20?(c+="<br/>(constructed)"):(this.tag==0x03||this.tag==0x04)&&this.sub!==null&&(c+="<br/>(encapsulates)");if(d!==null){c+="<br/>Value:<br/><b>"+d+"</b>";if(typeof oids==='object'&&this.tag==0x06){var g=oids[d];g&&(g.d&&(c+="<br/>"+g.d),g.c&&(c+="<br/>"+g.c),g.w&&(c+="<br/>(warning!)"))}}f.innerHTML=c;a.appendChild(f);var h=bf.tag("div","sub");if(this.sub!==null){for(var i=0,j=this.sub.length;i<j;++i)h.appendChild(this.sub[i].toDOM())}a.appendChild(h);b.onclick=function(){a.className=a.className=="node collapsed"?"node":"node collapsed"};return a}posStart(){return this.stream.pos}posContent(){return this.stream.pos+this.header}posEnd(){return this.stream.pos+this.header+Math.abs(this.length)}fakeHover(a){this.node.className+=" hover";a&&(this.head.className+=" hover")}fakeOut(a){var b=/ ?hover/;this.node.className=this.node.className.replace(b,"");a&&(this.head.className=this.head.className.replace(b,""))}toHexDOM_sub(a,b,c,d,e){if(d>=e)return;var f=bf.tag("span",b);f.appendChild(bf.text(c.hexDump(d,e)));a.appendChild(f)}toHexDOM(a){var b=bf.tag("span","hex");a===undefined&&(a=b);this.head.hexNode=b;this.head.onmouseover=function(){this.hexNode.className="hexCurrent"};this.head.onmouseout=function(){this.hexNode.className="hex"};b.asn1=this;b.onmouseover=function(){var b=!a.selected;b&&(a.selected=this.asn1,this.className="hexCurrent");this.asn1.fakeHover(b)};b.onmouseout=function(){var b=a.selected==this.asn1;this.asn1.fakeOut(b);b&&(a.selected=null,this.className="hex")};this.toHexDOM_sub(b,"tag",this.stream,this.posStart(),this.posStart()+1);this.toHexDOM_sub(b,this.length>=0?"dlen":"ulen",this.stream,this.posStart()+1,this.posContent());if(this.sub===null)b.appendChild(bf.text(this.stream.hexDump(this.posContent(),this.posEnd())));else if(this.sub.length>0){var c=this.sub[0],d=this.sub[this.sub.length-1];this.toHexDOM_sub(b,"intro",this.stream,this.posContent(),c.posStart());for(var e=0,f=this.sub.length;e<f;++e)b.appendChild(this.sub[e].toHexDOM(a));this.toHexDOM_sub(b,"outro",this.stream,d.posEnd(),this.posEnd())};return b}toHexString(a){return this.stream.hexDump(this.posStart(),this.posEnd(),!0)}}bh.decodeLength=function(a){var b=a.get(),c=b&0x7F;if(c==b)return c;if(c>3)throw "Length over 24 bits not supported at position "+(a.pos-1);if(c===0)return-1;b=0;for(var d=0;d<c;++d)b=b<<8|a.get();return b};bh.hasContent=function(a,b,c){if(a&0x20)return !0;if(a<0x03||a>0x04)return !1;var d=new bg(c);a==0x03&&d.get();var e=d.get();if(e>>6&0x01)return !1;try{var f=bh.decodeLength(d);return d.pos-c.pos+f==b}catch(a){return !1}};bh.decode=function(a){(a instanceof bg)||(a=new bg(a,0));var b=new bg(a),c=a.get(),d=bh.decodeLength(a),f=a.pos-b.pos,g=null;if(bh.hasContent(c,d,a)){var h=a.pos;c==0x03&&a.get();g=[];if(d>=0){var i=h+d;while(a.pos<i)g[g.length]=bh.decode(a);if(a.pos!=i)throw "Content size is not correct for container starting at offset "+h}else{try{for(;;){var j=bh.decode(a);if(j.tag===0)break;g[g.length]=j}d=h-a.pos}catch(a){throw "Exception while decoding undefined length content: "+a}}}else a.pos+=d;return new bh(b,f,d,c,g)};bh.test=function(){var a=[{value:[0x27],expected:0x27},{value:[0x81,0xC9],expected:0xC9},{value:[0x83,0xFE,0xDC,0xBA],expected:0xFEDCBA}];for(var b=0,c=a.length;b<c;++b){var d=new bg(a[b].value,0),e=bh.decodeLength(d);e!=a[b].expected&&document.write("In test["+b+"] expected "+a[b].expected+" got "+e+"\n")}};class bi{constructor(){this.i=0;this.j=0;this.S=[]}}function bj(a){var b,c,d;for(b=0;b<256;++b)this.S[b]=b;c=0;for(b=0;b<256;++b)c=c+this.S[b]+a[b%a.length]&255,d=this.S[b],this.S[b]=this.S[c],this.S[c]=d;this.i=0;this.j=0}function bk(){var a;this.i=this.i+1&255;this.j=this.j+this.S[this.i]&255;a=this.S[this.i];this.S[this.i]=this.S[this.j];this.S[this.j]=a;return this.S[a+this.S[this.i]&255]}bi.prototype.init=bj;bi.prototype.next=bk;function bl(){return new bi()}var bm=256,bn,bo,bp;if(bo==null){bo=new Array();bp=0;var bq;if(window.crypto&&window.crypto.getRandomValues){var br=new Uint32Array(256);window.crypto.getRandomValues(br);for(bq=0;bq<br.length;++bq)bo[bp++]=br[bq]&255}var bs=function(a){this.count=this.count||0;if(this.count>=256||bp>=bm){window.removeEventListener?window.removeEventListener("mousemove",bs,!1):window.detachEvent&&window.detachEvent("onmousemove",bs);return}try{var b=a.x+a.y;bo[bp++]=b&255;this.count+=1}catch(a){}};window.addEventListener?window.addEventListener("mousemove",bs,!1):window.attachEvent&&window.attachEvent("onmousemove",bs)}function bt(){if(bn==null){bn=bl();while(bp<bm){var a=Math.floor(65536*Math.random());bo[bp++]=a&255}bn.init(bo);for(bp=0;bp<bo.length;++bp)bo[bp]=0;bp=0}return bn.next()}function bu(a){var b;for(b=0;b<a.length;++b)a[b]=bt()}class bv{constructor(){}}bv.prototype.nextBytes=bu;var bw;class bx{constructor(a,b,c){a!=null&&("number"==typeof a?this.fromNumber(a,b,c):b==null&&"string"!=typeof a?this.fromString(a,256):this.fromString(a,b))}}function by(){return new bx(null)}function bz(a,b,c,d,e,f){while(--f>=0){var g=b*this[a++]+c[d]+e;e=Math.floor(g/0x4000000);c[d++]=g&0x3ffffff}return e}function bA(a,b,c,d,e,f){var g=b&0x7fff,h=b>>15;while(--f>=0){var i=this[a]&0x7fff,j=this[a++]>>15,k=h*i+j*g;i=g*i+((k&0x7fff)<<15)+c[d]+(e&0x3fffffff);e=(i>>>30)+(k>>>15)+h*j+(e>>>30);c[d++]=i&0x3fffffff}return e}function bB(a,b,c,d,e,f){var g=b&0x3fff,h=b>>14;while(--f>=0){var i=this[a]&0x3fff,j=this[a++]>>14,k=h*i+j*g;i=g*i+((k&0x3fff)<<14)+c[d]+e;e=(i>>28)+(k>>14)+h*j;c[d++]=i&0xfffffff}return e}navigator.appName=="Microsoft Internet Explorer"?(bx.prototype.am=bA,bw=30):navigator.appName!="Netscape"?(bx.prototype.am=bz,bw=26):(bx.prototype.am=bB,bw=28);bx.prototype.DB=bw;bx.prototype.DM=(1<<bw)-1;bx.prototype.DV=1<<bw;var bC=52;bx.prototype.FV=Math.pow(2,bC);bx.prototype.F1=bC-bw;bx.prototype.F2=2*bw-bC;var bD="0123456789abcdefghijklmnopqrstuvwxyz",bE=[],bF,bG;bF=48;for(bG=0;bG<=9;++bG)bE[bF++]=bG;bF=97;for(bG=10;bG<36;++bG)bE[bF++]=bG;bF=65;for(bG=10;bG<36;++bG)bE[bF++]=bG;function bH(a){return bD.charAt(a)}function bI(a,b){var c=bE[a.charCodeAt(b)];return c==null?-1:c}function bJ(a){for(var b=this.t-1;b>=0;--b)a[b]=this[b];a.t=this.t;a.s=this.s}function bK(a){this.t=1;this.s=a<0?-1:0;a>0?(this[0]=a):a<-1?(this[0]=a+this.DV):(this.t=0)}function bL(a){var b=by();b.fromInt(a);return b}function bM(a,b){var c;if(b==16)c=4;else if(b==8)c=3;else if(b==256)c=8;else if(b==2)c=1;else if(b==32)c=5;else if(b==4)c=2;else{this.fromRadix(a,b);return};this.t=0;this.s=0;var d=a.length,e=!1,f=0;while(--d>=0){var g=c==8?a[d]&0xff:bI(a,d);if(g<0){a.charAt(d)=="-"&&(e=!0);continue}e=!1;f==0?(this[this.t++]=g):f+c>this.DB?(this[this.t-1]|=(g&(1<<this.DB-f)-1)<<f,this[this.t++]=g>>this.DB-f):(this[this.t-1]|=g<<f);f+=c;f>=this.DB&&(f-=this.DB)}c==8&&(a[0]&0x80)!=0&&(this.s=-1,f>0&&(this[this.t-1]|=(1<<this.DB-f)-1<<f));this.clamp();e&&bx.ZERO.subTo(this,this)}function bN(){var a=this.s&this.DM;while(this.t>0&&this[this.t-1]==a)--this.t}function bO(a){if(this.s<0)return"-"+this.negate().toString(a);var b;if(a==16)b=4;else if(a==8)b=3;else if(a==2)b=1;else if(a==32)b=5;else if(a==4)b=2;else return this.toRadix(a);var c=(1<<b)-1,d,e=!1,f="",g=this.t,h=this.DB-g*this.DB%b;if(g-->0){h<this.DB&&(d=this[g]>>h)>0&&(e=!0,f=bH(d));while(g>=0)h<b?(d=(this[g]&(1<<h)-1)<<b-h,d|=this[--g]>>(h+=this.DB-b)):(d=this[g]>>(h-=b)&c,h<=0&&(h+=this.DB,--g)),d>0&&(e=!0),e&&(f+=bH(d))}return e?f:"0"}function bP(){var a=by();bx.ZERO.subTo(this,a);return a}function bQ(){return this.s<0?this.negate():this}function bR(a){var b=this.s-a.s;if(b!=0)return b;var c=this.t;b=c-a.t;if(b!=0)return this.s<0?-b:b;while(--c>=0)if((b=this[c]-a[c])!=0)return b;return 0}function bS(a){var b=1,c;(c=a>>>16)!=0&&(a=c,b+=16);(c=a>>8)!=0&&(a=c,b+=8);(c=a>>4)!=0&&(a=c,b+=4);(c=a>>2)!=0&&(a=c,b+=2);(c=a>>1)!=0&&(a=c,b+=1);return b}function bT(){if(this.t<=0)return 0;return this.DB*(this.t-1)+bS(this[this.t-1]^this.s&this.DM)}function bU(a,b){var c;for(c=this.t-1;c>=0;--c)b[c+a]=this[c];for(c=a-1;c>=0;--c)b[c]=0;b.t=this.t+a;b.s=this.s}function bV(a,b){for(var c=a;c<this.t;++c)b[c-a]=this[c];b.t=Math.max(this.t-a,0);b.s=this.s}function bW(a,b){var c=a%this.DB,d=this.DB-c,e=(1<<d)-1,f=Math.floor(a/this.DB),g=this.s<<c&this.DM,h;for(h=this.t-1;h>=0;--h)b[h+f+1]=this[h]>>d|g,g=(this[h]&e)<<c;for(h=f-1;h>=0;--h)b[h]=0;b[f]=g;b.t=this.t+f+1;b.s=this.s;b.clamp()}function bX(a,b){b.s=this.s;var c=Math.floor(a/this.DB);if(c>=this.t){b.t=0;return}var d=a%this.DB,e=this.DB-d,f=(1<<d)-1;b[0]=this[c]>>d;for(var g=c+1;g<this.t;++g)b[g-c-1]|=(this[g]&f)<<e,b[g-c]=this[g]>>d;d>0&&(b[this.t-c-1]|=(this.s&f)<<e);b.t=this.t-c;b.clamp()}function bY(a,b){var c=0,d=0,e=Math.min(a.t,this.t);while(c<e)d+=this[c]-a[c],b[c++]=d&this.DM,d>>=this.DB;if(a.t<this.t){d-=a.s;while(c<this.t)d+=this[c],b[c++]=d&this.DM,d>>=this.DB;d+=this.s}else{d+=this.s;while(c<a.t)d-=a[c],b[c++]=d&this.DM,d>>=this.DB;d-=a.s}b.s=d<0?-1:0;d<-1?(b[c++]=this.DV+d):d>0&&(b[c++]=d);b.t=c;b.clamp()}function bZ(a,b){var c=this.abs(),d=a.abs(),e=c.t;b.t=e+d.t;while(--e>=0)b[e]=0;for(e=0;e<d.t;++e)b[e+c.t]=c.am(0,d[e],b,e,0,c.t);b.s=0;b.clamp();this.s!=a.s&&bx.ZERO.subTo(b,b)}function b_(a){var b=this.abs(),c=a.t=2*b.t;while(--c>=0)a[c]=0;for(c=0;c<b.t-1;++c){var d=b.am(c,b[c],a,2*c,0,1);(a[c+b.t]+=b.am(c+1,2*b[c],a,2*c+1,d,b.t-c-1))>=b.DV&&(a[c+b.t]-=b.DV,a[c+b.t+1]=1)}a.t>0&&(a[a.t-1]+=b.am(c,b[c],a,2*c,0,1));a.s=0;a.clamp()}function b$(a,b,c){var d=a.abs();if(d.t<=0)return;var e=this.abs();if(e.t<d.t){b!=null&&b.fromInt(0);c!=null&&this.copyTo(c);return}c==null&&(c=by());var f=by(),g=this.s,h=a.s,i=this.DB-bS(d[d.t-1]);i>0?(d.lShiftTo(i,f),e.lShiftTo(i,c)):(d.copyTo(f),e.copyTo(c));var j=f.t,k=f[j-1];if(k==0)return;var l=k*(1<<this.F1)+(j>1?f[j-2]>>this.F2:0),m=this.FV/l,n=(1<<this.F1)/l,o=1<<this.F2,p=c.t,q=p-j,r=b==null?by():b;f.dlShiftTo(q,r);c.compareTo(r)>=0&&(c[c.t++]=1,c.subTo(r,c));bx.ONE.dlShiftTo(j,r);r.subTo(f,f);while(f.t<j)f[f.t++]=0;while(--q>=0){var s=c[--p]==k?this.DM:Math.floor(c[p]*m+(c[p-1]+o)*n);if((c[p]+=f.am(0,s,c,q,0,j))<s){f.dlShiftTo(q,r);c.subTo(r,c);while(c[p]<--s)c.subTo(r,c)}}b!=null&&(c.drShiftTo(j,b),g!=h&&bx.ZERO.subTo(b,b));c.t=j;c.clamp();i>0&&c.rShiftTo(i,c);g<0&&bx.ZERO.subTo(c,c)}function ca(a){var b=by();this.abs().divRemTo(a,null,b);this.s<0&&b.compareTo(bx.ZERO)>0&&a.subTo(b,b);return b}class cc{constructor(a){this.m=a}}function cd(a){if(a.s<0||a.compareTo(this.m)>=0)return a.mod(this.m);else return a}function ce(a){return a}function cf(a){a.divRemTo(this.m,null,a)}function cg(a,b,c){a.multiplyTo(b,c);this.reduce(c)}function ch(a,b){a.squareTo(b);this.reduce(b)}cc.prototype.convert=cd;cc.prototype.revert=ce;cc.prototype.reduce=cf;cc.prototype.mulTo=cg;cc.prototype.sqrTo=ch;function ci(){if(this.t<1)return 0;var a=this[0];if((a&1)==0)return 0;var b=a&3;b=b*(2-(a&0xf)*b)&0xf;b=b*(2-(a&0xff)*b)&0xff;b=b*(2-((a&0xffff)*b&0xffff))&0xffff;b=b*(2-a*b%this.DV)%this.DV;return b>0?this.DV-b:-b}class cj{constructor(a){this.m=a;this.mp=a.invDigit();this.mpl=this.mp&0x7fff;this.mph=this.mp>>15;this.um=(1<<a.DB-15)-1;this.mt2=2*a.t}}function ck(a){var b=by();a.abs().dlShiftTo(this.m.t,b);b.divRemTo(this.m,null,b);a.s<0&&b.compareTo(bx.ZERO)>0&&this.m.subTo(b,b);return b}function cl(a){var b=by();a.copyTo(b);this.reduce(b);return b}function cm(a){while(a.t<=this.mt2)a[a.t++]=0;for(var b=0;b<this.m.t;++b){var c=a[b]&0x7fff,d=c*this.mpl+((c*this.mph+(a[b]>>15)*this.mpl&this.um)<<15)&a.DM;c=b+this.m.t;a[c]+=this.m.am(0,d,a,b,0,this.m.t);while(a[c]>=a.DV)a[c]-=a.DV,a[++c]++}a.clamp();a.drShiftTo(this.m.t,a);a.compareTo(this.m)>=0&&a.subTo(this.m,a)}function cn(a,b){a.squareTo(b);this.reduce(b)}function co(a,b,c){a.multiplyTo(b,c);this.reduce(c)}cj.prototype.convert=ck;cj.prototype.revert=cl;cj.prototype.reduce=cm;cj.prototype.mulTo=co;cj.prototype.sqrTo=cn;function cp(){return(this.t>0?this[0]&1:this.s)==0}function cq(a,b){if(a>0xffffffff||a<1)return bx.ONE;var c=by(),d=by(),e=b.convert(this),f=bS(a)-1;e.copyTo(c);while(--f>=0){b.sqrTo(c,d);if((a&1<<f)>0)b.mulTo(d,e,c);else{var g=c;c=d;d=g}}return b.revert(c)}function cr(a,b){var c;a<256||b.isEven()?(c=new cc(b)):(c=new cj(b));return this.exp(a,c)}bx.prototype.copyTo=bJ;bx.prototype.fromInt=bK;bx.prototype.fromString=bM;bx.prototype.clamp=bN;bx.prototype.dlShiftTo=bU;bx.prototype.drShiftTo=bV;bx.prototype.lShiftTo=bW;bx.prototype.rShiftTo=bX;bx.prototype.subTo=bY;bx.prototype.multiplyTo=bZ;bx.prototype.squareTo=b_;bx.prototype.divRemTo=b$;bx.prototype.invDigit=ci;bx.prototype.isEven=cp;bx.prototype.exp=cq;bx.prototype.toString=bO;bx.prototype.negate=bP;bx.prototype.abs=bQ;bx.prototype.compareTo=bR;bx.prototype.bitLength=bT;bx.prototype.mod=ca;bx.prototype.modPowInt=cr;bx.ZERO=bL(0);bx.ONE=bL(1);function cs(){var a=by();this.copyTo(a);return a}function ct(){if(this.s<0){if(this.t==1)return this[0]-this.DV;else if(this.t==0)return-1}else if(this.t==1)return this[0];else if(this.t==0)return 0;return(this[1]&(1<<32-this.DB)-1)<<this.DB|this[0]}function cu(){return this.t==0?this.s:this[0]<<24>>24}function cv(){return this.t==0?this.s:this[0]<<16>>16}function cw(a){return Math.floor(Math.LN2*this.DB/Math.log(a))}function cx(){if(this.s<0)return-1;else if(this.t<=0||this.t==1&&this[0]<=0)return 0;else return 1}function cy(a){a==null&&(a=10);if(this.signum()==0||a<2||a>36)return"0";var b=this.chunkSize(a),c=Math.pow(a,b),d=bL(c),e=by(),f=by(),g="";this.divRemTo(d,e,f);while(e.signum()>0)g=(c+f.intValue()).toString(a).substr(1)+g,e.divRemTo(d,e,f);return f.intValue().toString(a)+g}function cz(a,b){this.fromInt(0);b==null&&(b=10);var c=this.chunkSize(b),d=Math.pow(b,c),e=!1,f=0,g=0;for(var h=0;h<a.length;++h){var i=bI(a,h);if(i<0){a.charAt(h)=="-"&&this.signum()==0&&(e=!0);continue}g=b*g+i;++f>=c&&(this.dMultiply(d),this.dAddOffset(g,0),f=0,g=0)}f>0&&(this.dMultiply(Math.pow(b,f)),this.dAddOffset(g,0));e&&bx.ZERO.subTo(this,this)}function cA(a,b,c){if("number"==typeof b){if(a<2)this.fromInt(1);else{this.fromNumber(a,c);this.testBit(a-1)||this.bitwiseTo(bx.ONE.shiftLeft(a-1),cI,this);this.isEven()&&this.dAddOffset(1,0);while(!this.isProbablePrime(b))this.dAddOffset(2,0),this.bitLength()>a&&this.subTo(bx.ONE.shiftLeft(a-1),this)}}else{var d=[],e=a&7;d.length=(a>>3)+1;b.nextBytes(d);e>0?(d[0]&=(1<<e)-1):(d[0]=0);this.fromString(d,256)}}function cB(){var a=this.t,b=[];b[0]=this.s;var c=this.DB-a*this.DB%8,d,e=0;if(a-->0){c<this.DB&&(d=this[a]>>c)!=(this.s&this.DM)>>c&&(b[e++]=d|this.s<<this.DB-c);while(a>=0)c<8?(d=(this[a]&(1<<c)-1)<<8-c,d|=this[--a]>>(c+=this.DB-8)):(d=this[a]>>(c-=8)&0xff,c<=0&&(c+=this.DB,--a)),(d&0x80)!=0&&(d|=-256),e==0&&(this.s&0x80)!=(d&0x80)&&++e,(e>0||d!=this.s)&&(b[e++]=d)}return b}function cC(a){return this.compareTo(a)==0}function cD(a){return this.compareTo(a)<0?this:a}function cE(a){return this.compareTo(a)>0?this:a}function cF(a,b,c){var d,e,f=Math.min(a.t,this.t);for(d=0;d<f;++d)c[d]=b(this[d],a[d]);if(a.t<this.t){e=a.s&this.DM;for(d=f;d<this.t;++d)c[d]=b(this[d],e);c.t=this.t}else{e=this.s&this.DM;for(d=f;d<a.t;++d)c[d]=b(e,a[d]);c.t=a.t}c.s=b(this.s,a.s);c.clamp()}function cG(a,b){return a&b}function cH(a){var b=by();this.bitwiseTo(a,cG,b);return b}function cI(a,b){return a|b}function cJ(a){var b=by();this.bitwiseTo(a,cI,b);return b}function cK(a,b){return a^b}function cL(a){var b=by();this.bitwiseTo(a,cK,b);return b}function cM(a,b){return a&~b}function cN(a){var b=by();this.bitwiseTo(a,cM,b);return b}function cO(){var a=by();for(var b=0;b<this.t;++b)a[b]=this.DM&~this[b];a.t=this.t;a.s=~this.s;return a}function cP(a){var b=by();a<0?this.rShiftTo(-a,b):this.lShiftTo(a,b);return b}function cQ(a){var b=by();a<0?this.lShiftTo(-a,b):this.rShiftTo(a,b);return b}function cR(a){if(a==0)return-1;var b=0;(a&0xffff)==0&&(a>>=16,b+=16);(a&0xff)==0&&(a>>=8,b+=8);(a&0xf)==0&&(a>>=4,b+=4);(a&3)==0&&(a>>=2,b+=2);(a&1)==0&&++b;return b}function cS(){for(var a=0;a<this.t;++a)if(this[a]!=0)return a*this.DB+cR(this[a]);if(this.s<0)return this.t*this.DB;return-1}function cT(a){var b=0;while(a!=0)a&=a-1,++b;return b}function cU(){var a=0,b=this.s&this.DM;for(var c=0;c<this.t;++c)a+=cT(this[c]^b);return a}function cV(a){var b=Math.floor(a/this.DB);if(b>=this.t)return this.s!=0;return(this[b]&1<<a%this.DB)!=0}function cW(a,b){var c=bx.ONE.shiftLeft(a);this.bitwiseTo(c,b,c);return c}function cX(a){return this.changeBit(a,cI)}function cY(a){return this.changeBit(a,cM)}function cZ(a){return this.changeBit(a,cK)}function c_(a,b){var c=0,d=0,e=Math.min(a.t,this.t);while(c<e)d+=this[c]+a[c],b[c++]=d&this.DM,d>>=this.DB;if(a.t<this.t){d+=a.s;while(c<this.t)d+=this[c],b[c++]=d&this.DM,d>>=this.DB;d+=this.s}else{d+=this.s;while(c<a.t)d+=a[c],b[c++]=d&this.DM,d>>=this.DB;d+=a.s}b.s=d<0?-1:0;d>0?(b[c++]=d):d<-1&&(b[c++]=this.DV+d);b.t=c;b.clamp()}function c$(a){var b=by();this.addTo(a,b);return b}function da(a){var b=by();this.subTo(a,b);return b}function db(a){var b=by();this.multiplyTo(a,b);return b}function dc(){var a=by();this.squareTo(a);return a}function dd(a){var b=by();this.divRemTo(a,b,null);return b}function de(a){var b=by();this.divRemTo(a,null,b);return b}function df(a){var b=by(),c=by();this.divRemTo(a,b,c);return new Array(b,c)}function dg(a){this[this.t]=this.am(0,a-1,this,0,0,this.t);++this.t;this.clamp()}function dh(a,b){if(a==0)return;while(this.t<=b)this[this.t++]=0;this[b]+=a;while(this[b]>=this.DV)this[b]-=this.DV,++b>=this.t&&(this[this.t++]=0),++this[b]}function di(){}function dj(a){return a}function dk(a,b,c){a.multiplyTo(b,c)}function dl(a,b){a.squareTo(b)}di.prototype.convert=dj;di.prototype.revert=dj;di.prototype.mulTo=dk;di.prototype.sqrTo=dl;function dm(a){return this.exp(a,new di())}function dn(a,b,c){var d=Math.min(this.t+a.t,b);c.s=0;c.t=d;while(d>0)c[--d]=0;var e;for(e=c.t-this.t;d<e;++d)c[d+this.t]=this.am(0,a[d],c,d,0,this.t);for(e=Math.min(a.t,b);d<e;++d)this.am(0,a[d],c,d,0,b-d);c.clamp()}function dp(a,b,c){--b;var d=c.t=this.t+a.t-b;c.s=0;while(--d>=0)c[d]=0;for(d=Math.max(b-this.t,0);d<a.t;++d)c[this.t+d-b]=this.am(b-d,a[d],c,0,0,this.t+d-b);c.clamp();c.drShiftTo(1,c)}function dq(a){this.r2=by();this.q3=by();bx.ONE.dlShiftTo(2*a.t,this.r2);this.mu=this.r2.divide(a);this.m=a}function dr(a){if(a.s<0||a.t>2*this.m.t)return a.mod(this.m);else if(a.compareTo(this.m)<0)return a;else{var b=by();a.copyTo(b);this.reduce(b);return b}}function ds(a){return a}function dt(a){a.drShiftTo(this.m.t-1,this.r2);a.t>this.m.t+1&&(a.t=this.m.t+1,a.clamp());this.mu.multiplyUpperTo(this.r2,this.m.t+1,this.q3);this.m.multiplyLowerTo(this.q3,this.m.t+1,this.r2);while(a.compareTo(this.r2)<0)a.dAddOffset(1,this.m.t+1);a.subTo(this.r2,a);while(a.compareTo(this.m)>=0)a.subTo(this.m,a)}function du(a,b){a.squareTo(b);this.reduce(b)}function dv(a,b,c){a.multiplyTo(b,c);this.reduce(c)}dq.prototype.convert=dr;dq.prototype.revert=ds;dq.prototype.reduce=dt;dq.prototype.mulTo=dv;dq.prototype.sqrTo=du;function dw(a,b){var c=a.bitLength(),d,e=bL(1),f;if(c<=0)return e;else c<18?(d=1):c<48?(d=3):c<144?(d=4):c<768?(d=5):(d=6);c<8?(f=new cc(b)):b.isEven()?(f=new dq(b)):(f=new cj(b));var g=[],h=3,i=d-1,j=(1<<d)-1;g[1]=f.convert(this);if(d>1){var k=by();f.sqrTo(g[1],k);while(h<=j)g[h]=by(),f.mulTo(k,g[h-2],g[h]),h+=2}var l=a.t-1,m,n=!0,o=by(),p;c=bS(a[l])-1;while(l>=0){c>=i?(m=a[l]>>c-i&j):(m=(a[l]&(1<<c+1)-1)<<i-c,l>0&&(m|=a[l-1]>>this.DB+c-i));h=d;while((m&1)==0)m>>=1,--h;(c-=h)<0&&(c+=this.DB,--l);if(n)g[m].copyTo(e),n=!1;else{while(h>1)f.sqrTo(e,o),f.sqrTo(o,e),h-=2;h>0?f.sqrTo(e,o):(p=e,e=o,o=p);f.mulTo(o,g[m],e)}while(l>=0&&(a[l]&1<<c)==0)f.sqrTo(e,o),p=e,e=o,o=p,--c<0&&(c=this.DB-1,--l)}return f.revert(e)}function dx(a){var b=this.s<0?this.negate():this.clone(),c=a.s<0?a.negate():a.clone();if(b.compareTo(c)<0){var d=b;b=c;c=d}var e=b.getLowestSetBit(),f=c.getLowestSetBit();if(f<0)return b;e<f&&(f=e);f>0&&(b.rShiftTo(f,b),c.rShiftTo(f,c));while(b.signum()>0)(e=b.getLowestSetBit())>0&&b.rShiftTo(e,b),(e=c.getLowestSetBit())>0&&c.rShiftTo(e,c),b.compareTo(c)>=0?(b.subTo(c,b),b.rShiftTo(1,b)):(c.subTo(b,c),c.rShiftTo(1,c));f>0&&c.lShiftTo(f,c);return c}function dy(a){if(a<=0)return 0;var b=this.DV%a,c=this.s<0?a-1:0;if(this.t>0)if(b==0)c=this[0]%a;else for(var d=this.t-1;d>=0;--d)c=(b*c+this[d])%a;return c}function dz(a){var b=a.isEven();if(this.isEven()&&b||a.signum()==0)return bx.ZERO;var c=a.clone(),d=this.clone(),e=bL(1),f=bL(0),g=bL(0),h=bL(1);while(c.signum()!=0){while(c.isEven())c.rShiftTo(1,c),b?((!e.isEven()||!f.isEven())&&(e.addTo(this,e),f.subTo(a,f)),e.rShiftTo(1,e)):f.isEven()||f.subTo(a,f),f.rShiftTo(1,f);while(d.isEven())d.rShiftTo(1,d),b?((!g.isEven()||!h.isEven())&&(g.addTo(this,g),h.subTo(a,h)),g.rShiftTo(1,g)):h.isEven()||h.subTo(a,h),h.rShiftTo(1,h);c.compareTo(d)>=0?(c.subTo(d,c),b&&e.subTo(g,e),f.subTo(h,f)):(d.subTo(c,d),b&&g.subTo(e,g),h.subTo(f,h))}if(d.compareTo(bx.ONE)!=0)return bx.ZERO;if(h.compareTo(a)>=0)return h.subtract(a);if(h.signum()<0)h.addTo(a,h);else return h;if(h.signum()<0)return h.add(a);else return h}var dA=[2,3,5,7,11,13,17,19,23,29,31,37,41,43,47,53,59,61,67,71,73,79,83,89,97,101,103,107,109,113,127,131,137,139,149,151,157,163,167,173,179,181,191,193,197,199,211,223,227,229,233,239,241,251,257,263,269,271,277,281,283,293,307,311,313,317,331,337,347,349,353,359,367,373,379,383,389,397,401,409,419,421,431,433,439,443,449,457,461,463,467,479,487,491,499,503,509,521,523,541,547,557,563,569,571,577,587,593,599,601,607,613,617,619,631,641,643,647,653,659,661,673,677,683,691,701,709,719,727,733,739,743,751,757,761,769,773,787,797,809,811,821,823,827,829,839,853,857,859,863,877,881,883,887,907,911,919,929,937,941,947,953,967,971,977,983,991,997],dB=67108864/dA[dA.length-1];function dC(a){var b,c=this.abs();if(c.t==1&&c[0]<=dA[dA.length-1]){for(b=0;b<dA.length;++b)if(c[0]==dA[b])return !0;return !1}if(c.isEven())return !1;b=1;while(b<dA.length){var d=dA[b],e=b+1;while(e<dA.length&&d<dB)d*=dA[e++];d=c.modInt(d);while(b<e)if(d%dA[b++]==0)return !1}return c.millerRabin(a)}function dD(a){var b=this.subtract(bx.ONE),c=b.getLowestSetBit();if(c<=0)return !1;var d=b.shiftRight(c);a=a+1>>1;a>dA.length&&(a=dA.length);var e=by();for(var f=0;f<a;++f){e.fromInt(dA[Math.floor(Math.random()*dA.length)]);var g=e.modPow(d,this);if(g.compareTo(bx.ONE)!=0&&g.compareTo(b)!=0){var h=1;while(h++<c&&g.compareTo(b)!=0){g=g.modPowInt(2,this);if(g.compareTo(bx.ONE)==0)return !1}if(g.compareTo(b)!=0)return !1}}return !0}bx.prototype.chunkSize=cw;bx.prototype.toRadix=cy;bx.prototype.fromRadix=cz;bx.prototype.fromNumber=cA;bx.prototype.bitwiseTo=cF;bx.prototype.changeBit=cW;bx.prototype.addTo=c_;bx.prototype.dMultiply=dg;bx.prototype.dAddOffset=dh;bx.prototype.multiplyLowerTo=dn;bx.prototype.multiplyUpperTo=dp;bx.prototype.modInt=dy;bx.prototype.millerRabin=dD;bx.prototype.clone=cs;bx.prototype.intValue=ct;bx.prototype.byteValue=cu;bx.prototype.shortValue=cv;bx.prototype.signum=cx;bx.prototype.toByteArray=cB;bx.prototype.equals=cC;bx.prototype.min=cD;bx.prototype.max=cE;bx.prototype.and=cH;bx.prototype.or=cJ;bx.prototype.xor=cL;bx.prototype.andNot=cN;bx.prototype.not=cO;bx.prototype.shiftLeft=cP;bx.prototype.shiftRight=cQ;bx.prototype.getLowestSetBit=cS;bx.prototype.bitCount=cU;bx.prototype.testBit=cV;bx.prototype.setBit=cX;bx.prototype.clearBit=cY;bx.prototype.flipBit=cZ;bx.prototype.add=c$;bx.prototype.subtract=da;bx.prototype.multiply=db;bx.prototype.divide=dd;bx.prototype.remainder=de;bx.prototype.divideAndRemainder=df;bx.prototype.modPow=dw;bx.prototype.modInverse=dz;bx.prototype.pow=dm;bx.prototype.gcd=dx;bx.prototype.isProbablePrime=dC;bx.prototype.square=dc;function dE(a,b){return new bx(a,b)}function dF(a,b){if(b<a.length+11){console.error("Message too long for RSA");return null}var c=[],d=a.length-1;while(d>=0&&b>0){var e=a.charCodeAt(d--);e<128?(c[--b]=e):e>127&&e<2048?(c[--b]=e&63|128,c[--b]=e>>6|192):(c[--b]=e&63|128,c[--b]=e>>6&63|128,c[--b]=e>>12|224)}c[--b]=0;var f=new bv(),g=[];while(b>2){g[0]=0;while(g[0]==0)f.nextBytes(g);c[--b]=g[0]}c[--b]=2;c[--b]=0;return new bx(c)}class dG{constructor(){this.n=null;this.e=0;this.d=null;this.p=null;this.q=null;this.dmp1=null;this.dmq1=null;this.coeff=null}}function dH(a,b){a!=null&&b!=null&&a.length>0&&b.length>0?(this.n=dE(a,16),this.e=parseInt(b,16)):console.error("Invalid RSA public key")}function dI(a){return a.modPowInt(this.e,this.n)}function dJ(a){var b=dF(a,this.n.bitLength()+7>>3);if(b==null)return null;var c=this.doPublic(b);if(c==null)return null;var d=c.toString(16);if((d.length&1)==0)return d;else return"0"+d}dG.prototype.doPublic=dI;dG.prototype.setPublic=dH;dG.prototype.encrypt=dJ;function dK(a,b){var c=a.toByteArray(),d=0;while(d<c.length&&c[d]==0)++d;if(c.length-d!=b-1||c[d]!=2)return null;++d;while(c[d]!=0)if(++d>=c.length)return null;var e="";while(++d<c.length){var f=c[d]&255;f<128?(e+=String.fromCharCode(f)):f>191&&f<224?(e+=String.fromCharCode((f&31)<<6|c[d+1]&63),++d):(e+=String.fromCharCode((f&15)<<12|(c[d+1]&63)<<6|c[d+2]&63),d+=2)}return e}function dL(a,b,c){a!=null&&b!=null&&a.length>0&&b.length>0?(this.n=dE(a,16),this.e=parseInt(b,16),this.d=dE(c,16)):console.error("Invalid RSA private key")}function dM(a,b,c,d,e,f,g,h){a!=null&&b!=null&&a.length>0&&b.length>0?(this.n=dE(a,16),this.e=parseInt(b,16),this.d=dE(c,16),this.p=dE(d,16),this.q=dE(e,16),this.dmp1=dE(f,16),this.dmq1=dE(g,16),this.coeff=dE(h,16)):console.error("Invalid RSA private key")}function dN(a,b){var c=new bv(),d=a>>1;this.e=parseInt(b,16);var e=new bx(b,16);for(;;){for(;;){this.p=new bx(a-d,1,c);if(this.p.subtract(bx.ONE).gcd(e).compareTo(bx.ONE)==0&&this.p.isProbablePrime(10))break}for(;;){this.q=new bx(d,1,c);if(this.q.subtract(bx.ONE).gcd(e).compareTo(bx.ONE)==0&&this.q.isProbablePrime(10))break}if(this.p.compareTo(this.q)<=0){var f=this.p;this.p=this.q;this.q=f}var g=this.p.subtract(bx.ONE),h=this.q.subtract(bx.ONE),i=g.multiply(h);if(i.gcd(e).compareTo(bx.ONE)==0){this.n=this.p.multiply(this.q);this.d=e.modInverse(i);this.dmp1=this.d.mod(g);this.dmq1=this.d.mod(h);this.coeff=this.q.modInverse(this.p);break}}}function dO(a){if(this.p==null||this.q==null)return a.modPow(this.d,this.n);var b=a.mod(this.p).modPow(this.dmp1,this.p),c=a.mod(this.q).modPow(this.dmq1,this.q);while(b.compareTo(c)<0)b=b.add(this.p);return b.subtract(c).multiply(this.coeff).mod(this.p).multiply(this.q).add(c)}function dP(a){var b=dE(a,16),c=this.doPrivate(b);if(c==null)return null;return dK(c,this.n.bitLength()+7>>3)}dG.prototype.doPrivate=dO;dG.prototype.setPrivate=dL;dG.prototype.setPrivateEx=dM;dG.prototype.generate=dN;dG.prototype.decrypt=dP;let dQ={},dR;dQ.decode=function(a){var b;if(dR===undefined){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d="= \f\n\r\t\u00A0\u2028\u2029";dR=[];for(b=0;b<64;++b)dR[c.charAt(b)]=b;for(b=0;b<d.length;++b)dR[d.charAt(b)]=-1}var e=[],f=0,g=0;for(b=0;b<a.length;++b){var h=a.charAt(b);if(h=='=')break;h=dR[h];if(h==-1)continue;if(h===undefined)throw 'Illegal character at offset '+b;f|=h;++g>=4?(e[e.length]=f>>16,e[e.length]=f>>8&0xFF,e[e.length]=f&0xFF,f=0,g=0):(f<<=6)}switch(g){case 1:throw "Base64 encoding incomplete: at least 2 bits missing";case 2:e[e.length]=f>>10;break;case 3:e[e.length]=f>>16;e[e.length]=f>>8&0xFF;break};return e};dQ.re=/-----BEGIN [^-]+-----([A-Za-z0-9+\/=\s]+)-----END [^-]+-----|begin-base64[^\n]+\n([A-Za-z0-9+\/=\s]+)====/;dQ.unarmor=function(a){var b=dQ.re.exec(a);if(b){if(b[1])a=b[1];else if(b[2])a=b[2];else throw "RegExp out of sync"}return dQ.decode(a)};let dS={},dT;dS.decode=function(a){var b;if(dT===undefined){var c="0123456789ABCDEF",d=" \f\n\r\t\u00A0\u2028\u2029";dT=[];for(b=0;b<16;++b)dT[c.charAt(b)]=b;c=c.toLowerCase();for(b=10;b<16;++b)dT[c.charAt(b)]=b;for(b=0;b<d.length;++b)dT[d.charAt(b)]=-1}var e=[],f=0,g=0;for(b=0;b<a.length;++b){var h=a.charAt(b);if(h=='=')break;h=dT[h];if(h==-1)continue;if(h===undefined)throw 'Illegal character at offset '+b;f|=h;++g>=2?(e[e.length]=f,f=0,g=0):(f<<=4)}if(g)throw "Hex encoding incomplete: 4 bits missing";return e};let dU={};dU.env=dU.env||{};var dV=dU,dW=Object.prototype,dX='[object Function]',dY=["toString","valueOf"];dU.env.parseUA=function(a){var b=function(a){var b=0;return parseFloat(a.replace(/\./g,function(){return b++==1?'':'.'}))},c=navigator,d={ie:0,opera:0,gecko:0,webkit:0,chrome:0,mobile:null,air:0,ipad:0,iphone:0,ipod:0,ios:null,android:0,webos:0,caja:c&&c.cajaVersion,secure:!1,os:null},e=a||navigator&&navigator.userAgent,f=window&&window.location,g=f&&f.href,h;d.secure=g&&g.toLowerCase().indexOf("https")===0;e&&(/windows|win32/i.test(e)?(d.os='windows'):/macintosh/i.test(e)?(d.os='macintosh'):/rhino/i.test(e)&&(d.os='rhino'),/KHTML/.test(e)&&(d.webkit=1),h=e.match(/AppleWebKit\/([^\s]*)/),h&&h[1]&&(d.webkit=b(h[1]),/ Mobile\//.test(e)?(d.mobile='Apple',h=e.match(/OS ([^\s]*)/),h&&h[1]&&(h=b(h[1].replace('_','.'))),d.ios=h,d.ipad=d.ipod=d.iphone=0,h=e.match(/iPad|iPod|iPhone/),h&&h[0]&&(d[h[0].toLowerCase()]=d.ios)):(h=e.match(/NokiaN[^\/]*|Android \d\.\d|webOS\/\d\.\d/),h&&(d.mobile=h[0]),/webOS/.test(e)&&(d.mobile='WebOS',h=e.match(/webOS\/([^\s]*);/),h&&h[1]&&(d.webos=b(h[1]))),/ Android/.test(e)&&(d.mobile='Android',h=e.match(/Android ([^\s]*);/),h&&h[1]&&(d.android=b(h[1])))),h=e.match(/Chrome\/([^\s]*)/),h&&h[1]?(d.chrome=b(h[1])):(h=e.match(/AdobeAIR\/([^\s]*)/),h&&(d.air=h[0]))),d.webkit||(h=e.match(/Opera[\s\/]([^\s]*)/),h&&h[1]?(d.opera=b(h[1]),h=e.match(/Version\/([^\s]*)/),h&&h[1]&&(d.opera=b(h[1])),h=e.match(/Opera Mini[^;]*/),h&&(d.mobile=h[0])):(h=e.match(/MSIE\s([^;]*)/),h&&h[1]?(d.ie=b(h[1])):(h=e.match(/Gecko\/([^\s]*)/),h&&(d.gecko=1,h=e.match(/rv:([^\s\)]*)/),h&&h[1]&&(d.gecko=b(h[1])))))));return d};dU.env.ua=dU.env.parseUA();dU.isFunction=function(a){return typeof a==='function'||dW.toString.apply(a)===dX};dU._IEEnumFix=dU.env.ua.ie?function(a,b){var c,d,e;for(c=0;c<dY.length;c+=1)d=dY[c],e=b[d],dV.isFunction(e)&&e!=dW[d]&&(a[d]=e)}:function(){};dU.extend=function(a,b,c){if(!b||!a){throw new Error("extend failed, please check that all dependencies are included.")}var d=function(){},e;d.prototype=b.prototype;a.prototype=new d();a.prototype.constructor=a;a.superclass=b.prototype;b.prototype.constructor==dW.constructor&&(b.prototype.constructor=b);if(c){for(e in c)dV.hasOwnProperty(c,e)&&(a.prototype[e]=c[e]);dV._IEEnumFix(a.prototype,c)}};let dZ={};(typeof dZ.asn1=="undefined"||!dZ.asn1)&&(dZ.asn1={});dZ.asn1.ASN1Util=new function(){this.integerToByteHex=function(a){var b=a.toString(16);b.length%2==1&&(b='0'+b);return b};this.bigIntToMinTwosComplementsHex=function(a){var b=a.toString(16);if(b.substr(0,1)!='-')b.length%2==1?(b='0'+b):b.match(/^[0-7]/)||(b='00'+b);else{var c=b.substr(1),d=c.length;d%2==1?(d+=1):b.match(/^[0-7]/)||(d+=2);var e='';for(var f=0;f<d;f++)e+='f';var g=new bx(e,16),h=g.xor(a).add(bx.ONE);b=h.toString(16).replace(/^-/,'')}return b};this.getPEMStringFromHex=function(a,b){var c=CryptoJS.enc.Hex.parse(a),d=CryptoJS.enc.Base64.stringify(c),e=d.replace(/(.{64})/g,"$1\r\n");e=e.replace(/\r\n$/,'');return"-----BEGIN "+b+"-----\r\n"+e+"\r\n-----END "+b+"-----\r\n"}};dZ.asn1.ASN1Object=function(){var a='';this.getLengthHexFromValue=function(){if(typeof this.hV=="undefined"||this.hV==null){throw "this.hV is null or undefined."}if(this.hV.length%2==1){throw "value hex must be even length: n="+a.length+",v="+this.hV}var b=this.hV.length/2,c=b.toString(16);c.length%2==1&&(c="0"+c);if(b<128){return c}else{var d=c.length/2;if(d>15){throw "ASN.1 length too long to represent by 8x: n = "+b.toString(16)}var e=128+d;return e.toString(16)+c}};this.getEncodedHex=function(){(this.hTLV==null||this.isModified)&&(this.hV=this.getFreshValueHex(),this.hL=this.getLengthHexFromValue(),this.hTLV=this.hT+this.hL+this.hV,this.isModified=!1);return this.hTLV};this.getValueHex=function(){this.getEncodedHex();return this.hV};this.getFreshValueHex=function(){return''}};dZ.asn1.DERAbstractString=function(a){dZ.asn1.DERAbstractString.superclass.constructor.call(this);this.getString=function(){return this.s};this.setString=function(a){this.hTLV=null;this.isModified=!0;this.s=a;this.hV=stohex(this.s)};this.setStringHex=function(a){this.hTLV=null;this.isModified=!0;this.s=null;this.hV=a};this.getFreshValueHex=function(){return this.hV};typeof a!="undefined"&&(typeof a.str!="undefined"?this.setString(a.str):typeof a.hex!="undefined"&&this.setStringHex(a.hex))};dU.extend(dZ.asn1.DERAbstractString,dZ.asn1.ASN1Object);dZ.asn1.DERAbstractTime=function(a){dZ.asn1.DERAbstractTime.superclass.constructor.call(this);this.localDateToUTC=function(a){utc=a.getTime()+a.getTimezoneOffset()*60000;var b=new Date(utc);return b};this.formatDate=function(a,b){var c=this.zeroPadding,d=this.localDateToUTC(a),e=String(d.getFullYear());b=='utc'&&(e=e.substr(2,2));var f=c(String(d.getMonth()+1),2),g=c(String(d.getDate()),2),h=c(String(d.getHours()),2),i=c(String(d.getMinutes()),2),j=c(String(d.getSeconds()),2);return e+f+g+h+i+j+'Z'};this.zeroPadding=function(a,b){if(a.length>=b)return a;return new Array(b-a.length+1).join('0')+a};this.getString=function(){return this.s};this.setString=function(a){this.hTLV=null;this.isModified=!0;this.s=a;this.hV=stohex(this.s)};this.setByDateValue=function(a,b,c,d,e,f){var g=new Date(Date.UTC(a,b-1,c,d,e,f,0));this.setByDate(g)};this.getFreshValueHex=function(){return this.hV}};dU.extend(dZ.asn1.DERAbstractTime,dZ.asn1.ASN1Object);dZ.asn1.DERAbstractStructured=function(a){dZ.asn1.DERAbstractString.superclass.constructor.call(this);this.setByASN1ObjectArray=function(a){this.hTLV=null;this.isModified=!0;this.asn1Array=a};this.appendASN1Object=function(a){this.hTLV=null;this.isModified=!0;this.asn1Array.push(a)};this.asn1Array=new Array();typeof a!="undefined"&&(typeof a.array!="undefined"&&(this.asn1Array=a.array))};dU.extend(dZ.asn1.DERAbstractStructured,dZ.asn1.ASN1Object);dZ.asn1.DERBoolean=function(){dZ.asn1.DERBoolean.superclass.constructor.call(this);this.hT="01";this.hTLV="0101ff"};dU.extend(dZ.asn1.DERBoolean,dZ.asn1.ASN1Object);dZ.asn1.DERInteger=function(a){dZ.asn1.DERInteger.superclass.constructor.call(this);this.hT="02";this.setByBigInteger=function(a){this.hTLV=null;this.isModified=!0;this.hV=dZ.asn1.ASN1Util.bigIntToMinTwosComplementsHex(a)};this.setByInteger=function(a){var b=new bx(String(a),10);this.setByBigInteger(b)};this.setValueHex=function(a){this.hV=a};this.getFreshValueHex=function(){return this.hV};typeof a!="undefined"&&(typeof a.bigint!="undefined"?this.setByBigInteger(a.bigint):typeof a.int!="undefined"?this.setByInteger(a.int):typeof a.hex!="undefined"&&this.setValueHex(a.hex))};dU.extend(dZ.asn1.DERInteger,dZ.asn1.ASN1Object);dZ.asn1.DERBitString=function(a){dZ.asn1.DERBitString.superclass.constructor.call(this);this.hT="03";this.setHexValueIncludingUnusedBits=function(a){this.hTLV=null;this.isModified=!0;this.hV=a};this.setUnusedBitsAndHexValue=function(a,b){if(a<0||7<a){throw "unused bits shall be from 0 to 7: u = "+a}var c="0"+a;this.hTLV=null;this.isModified=!0;this.hV=c+b};this.setByBinaryString=function(a){a=a.replace(/0+$/,'');var b=8-a.length%8;b==8&&(b=0);for(var c=0;c<=b;c++)a+='0';var d='';for(c=0;c<a.length-1;c+=8){var e=a.substr(c,8),f=parseInt(e,2).toString(16);f.length==1&&(f='0'+f);d+=f}this.hTLV=null;this.isModified=!0;this.hV='0'+b+d};this.setByBooleanArray=function(a){var b='';for(var c=0;c<a.length;c++)a[c]==!0?(b+='1'):(b+='0');this.setByBinaryString(b)};this.newFalseArray=function(a){var b=new Array(a);for(var c=0;c<a;c++)b[c]=!1;return b};this.getFreshValueHex=function(){return this.hV};typeof a!="undefined"&&(typeof a.hex!="undefined"?this.setHexValueIncludingUnusedBits(a.hex):typeof a.bin!="undefined"?this.setByBinaryString(a.bin):typeof a.array!="undefined"&&this.setByBooleanArray(a.array))};dU.extend(dZ.asn1.DERBitString,dZ.asn1.ASN1Object);dZ.asn1.DEROctetString=function(a){dZ.asn1.DEROctetString.superclass.constructor.call(this,a);this.hT="04"};dU.extend(dZ.asn1.DEROctetString,dZ.asn1.DERAbstractString);dZ.asn1.DERNull=function(){dZ.asn1.DERNull.superclass.constructor.call(this);this.hT="05";this.hTLV="0500"};dU.extend(dZ.asn1.DERNull,dZ.asn1.ASN1Object);dZ.asn1.DERObjectIdentifier=function(a){var b=function(a){var b=a.toString(16);b.length==1&&(b='0'+b);return b},c=function(a){var c='',d=new bx(a,10),e=d.toString(2),f=7-e.length%7;f==7&&(f=0);var g='';for(var h=0;h<f;h++)g+='0';e=g+e;for(h=0;h<e.length-1;h+=7){var i=e.substr(h,7);h!=e.length-7&&(i='1'+i);c+=b(parseInt(i,2))}return c};dZ.asn1.DERObjectIdentifier.superclass.constructor.call(this);this.hT="06";this.setValueHex=function(a){this.hTLV=null;this.isModified=!0;this.s=null;this.hV=a};this.setValueOidString=function(a){if(!a.match(/^[0-9.]+$/)){throw "malformed oid string: "+a}var d='',e=a.split('.'),f=parseInt(e[0])*40+parseInt(e[1]);d+=b(f);e.splice(0,2);for(var g=0;g<e.length;g++)d+=c(e[g]);this.hTLV=null;this.isModified=!0;this.s=null;this.hV=d};this.setValueName=function(a){if(typeof dZ.asn1.x509.OID.name2oidList[a]!="undefined"){var b=dZ.asn1.x509.OID.name2oidList[a];this.setValueOidString(b)}else{throw "DERObjectIdentifier oidName undefined: "+a}};this.getFreshValueHex=function(){return this.hV};typeof a!="undefined"&&(typeof a.oid!="undefined"?this.setValueOidString(a.oid):typeof a.hex!="undefined"?this.setValueHex(a.hex):typeof a.name!="undefined"&&this.setValueName(a.name))};dU.extend(dZ.asn1.DERObjectIdentifier,dZ.asn1.ASN1Object);dZ.asn1.DERUTF8String=function(a){dZ.asn1.DERUTF8String.superclass.constructor.call(this,a);this.hT="0c"};dU.extend(dZ.asn1.DERUTF8String,dZ.asn1.DERAbstractString);dZ.asn1.DERNumericString=function(a){dZ.asn1.DERNumericString.superclass.constructor.call(this,a);this.hT="12"};dU.extend(dZ.asn1.DERNumericString,dZ.asn1.DERAbstractString);dZ.asn1.DERPrintableString=function(a){dZ.asn1.DERPrintableString.superclass.constructor.call(this,a);this.hT="13"};dU.extend(dZ.asn1.DERPrintableString,dZ.asn1.DERAbstractString);dZ.asn1.DERTeletexString=function(a){dZ.asn1.DERTeletexString.superclass.constructor.call(this,a);this.hT="14"};dU.extend(dZ.asn1.DERTeletexString,dZ.asn1.DERAbstractString);dZ.asn1.DERIA5String=function(a){dZ.asn1.DERIA5String.superclass.constructor.call(this,a);this.hT="16"};dU.extend(dZ.asn1.DERIA5String,dZ.asn1.DERAbstractString);dZ.asn1.DERUTCTime=function(a){dZ.asn1.DERUTCTime.superclass.constructor.call(this,a);this.hT="17";this.setByDate=function(a){this.hTLV=null;this.isModified=!0;this.date=a;this.s=this.formatDate(this.date,'utc');this.hV=stohex(this.s)};typeof a!="undefined"&&(typeof a.str!="undefined"?this.setString(a.str):typeof a.hex!="undefined"?this.setStringHex(a.hex):typeof a.date!="undefined"&&this.setByDate(a.date))};dU.extend(dZ.asn1.DERUTCTime,dZ.asn1.DERAbstractTime);dZ.asn1.DERGeneralizedTime=function(a){dZ.asn1.DERGeneralizedTime.superclass.constructor.call(this,a);this.hT="18";this.setByDate=function(a){this.hTLV=null;this.isModified=!0;this.date=a;this.s=this.formatDate(this.date,'gen');this.hV=stohex(this.s)};typeof a!="undefined"&&(typeof a.str!="undefined"?this.setString(a.str):typeof a.hex!="undefined"?this.setStringHex(a.hex):typeof a.date!="undefined"&&this.setByDate(a.date))};dU.extend(dZ.asn1.DERGeneralizedTime,dZ.asn1.DERAbstractTime);dZ.asn1.DERSequence=function(a){dZ.asn1.DERSequence.superclass.constructor.call(this,a);this.hT="30";this.getFreshValueHex=function(){var a='';for(var b=0;b<this.asn1Array.length;b++){var c=this.asn1Array[b];a+=c.getEncodedHex()}this.hV=a;return this.hV}};dU.extend(dZ.asn1.DERSequence,dZ.asn1.DERAbstractStructured);dZ.asn1.DERSet=function(a){dZ.asn1.DERSet.superclass.constructor.call(this,a);this.hT="31";this.getFreshValueHex=function(){var a=new Array();for(var b=0;b<this.asn1Array.length;b++){var c=this.asn1Array[b];a.push(c.getEncodedHex())}a.sort();this.hV=a.join('');return this.hV}};dU.extend(dZ.asn1.DERSet,dZ.asn1.DERAbstractStructured);dZ.asn1.DERTaggedObject=function(a){dZ.asn1.DERTaggedObject.superclass.constructor.call(this);this.hT="a0";this.hV='';this.isExplicit=!0;this.asn1Object=null;this.setASN1Object=function(a,b,c){this.hT=b;this.isExplicit=a;this.asn1Object=c;this.isExplicit?(this.hV=this.asn1Object.getEncodedHex(),this.hTLV=null,this.isModified=!0):(this.hV=null,this.hTLV=c.getEncodedHex(),this.hTLV=this.hTLV.replace(/^../,b),this.isModified=!1)};this.getFreshValueHex=function(){return this.hV};typeof a!="undefined"&&(typeof a.tag!="undefined"&&(this.hT=a.tag),typeof a.explicit!="undefined"&&(this.isExplicit=a.explicit),typeof a.obj!="undefined"&&(this.asn1Object=a.obj,this.setASN1Object(this.isExplicit,this.hT,this.asn1Object)))};dU.extend(dZ.asn1.DERTaggedObject,dZ.asn1.ASN1Object);var d_="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d$="=";function ea(a){var b,c,d="";for(b=0;b+3<=a.length;b+=3)c=parseInt(a.substring(b,b+3),16),d+=d_.charAt(c>>6)+d_.charAt(c&63);b+1==a.length?(c=parseInt(a.substring(b,b+1),16),d+=d_.charAt(c<<2)):b+2==a.length&&(c=parseInt(a.substring(b,b+2),16),d+=d_.charAt(c>>2)+d_.charAt((c&3)<<4));while((d.length&3)>0)d+=d$;return d}function eb(a){var b="",c,d=0,e;for(c=0;c<a.length;++c){if(a.charAt(c)==d$)break;let f=d_.indexOf(a.charAt(c));if(f<0)continue;d==0?(b+=bH(f>>2),e=f&3,d=1):d==1?(b+=bH(e<<2|f>>4),e=f&0xf,d=2):d==2?(b+=bH(e),b+=bH(f>>2),e=f&3,d=3):(b+=bH(e<<2|f>>4),b+=bH(f&0xf),d=0)}d==1&&(b+=bH(e<<2));return b}bh.prototype.getHexStringValue=function(){var a=this.toHexString(),b=this.header*2,c=this.length*2;return a.substr(b,c)};dG.prototype.parseKey=function(a){try{var b=0,c=0,d=/^\s*(?:[0-9A-Fa-f][0-9A-Fa-f]\s*)+$/,e=d.test(a)?dS.decode(a):dQ.unarmor(a),f=bh.decode(e);f.sub.length===3&&(f=f.sub[2].sub[0]);if(f.sub.length===9){b=f.sub[1].getHexStringValue();this.n=dE(b,16);c=f.sub[2].getHexStringValue();this.e=parseInt(c,16);var g=f.sub[3].getHexStringValue();this.d=dE(g,16);var h=f.sub[4].getHexStringValue();this.p=dE(h,16);var i=f.sub[5].getHexStringValue();this.q=dE(i,16);var j=f.sub[6].getHexStringValue();this.dmp1=dE(j,16);var k=f.sub[7].getHexStringValue();this.dmq1=dE(k,16);var l=f.sub[8].getHexStringValue();this.coeff=dE(l,16)}else if(f.sub.length===2){var m=f.sub[1],n=m.sub[0];b=n.sub[0].getHexStringValue();this.n=dE(b,16);c=n.sub[1].getHexStringValue();this.e=parseInt(c,16)}else{return !1};return !0}catch(a){return !1}};dG.prototype.getPrivateBaseKey=function(){var a={'array':[new dZ.asn1.DERInteger({'int':0}),new dZ.asn1.DERInteger({'bigint':this.n}),new dZ.asn1.DERInteger({'int':this.e}),new dZ.asn1.DERInteger({'bigint':this.d}),new dZ.asn1.DERInteger({'bigint':this.p}),new dZ.asn1.DERInteger({'bigint':this.q}),new dZ.asn1.DERInteger({'bigint':this.dmp1}),new dZ.asn1.DERInteger({'bigint':this.dmq1}),new dZ.asn1.DERInteger({'bigint':this.coeff})]},b=new dZ.asn1.DERSequence(a);return b.getEncodedHex()};dG.prototype.getPrivateBaseKeyB64=function(){return ea(this.getPrivateBaseKey())};dG.prototype.getPublicBaseKey=function(){var a={'array':[new dZ.asn1.DERObjectIdentifier({'oid':'1.2.840.113549.1.1.1'}),new dZ.asn1.DERNull()]},b=new dZ.asn1.DERSequence(a);a={'array':[new dZ.asn1.DERInteger({'bigint':this.n}),new dZ.asn1.DERInteger({'int':this.e})]};var c=new dZ.asn1.DERSequence(a);a={'hex':'00'+c.getEncodedHex()};var d=new dZ.asn1.DERBitString(a);a={'array':[b,d]};var e=new dZ.asn1.DERSequence(a);return e.getEncodedHex()};dG.prototype.getPublicBaseKeyB64=function(){return ea(this.getPublicBaseKey())};dG.prototype.wordwrap=function(a,b){b=b||64;if(!a){return a}var c='(.{1,'+b+'})( +|$\n?)|(.{1,'+b+'})';return a.match(RegExp(c,'g')).join('\n')};dG.prototype.getPrivateKey=function(){var a="-----BEGIN RSA PRIVATE KEY-----\n";a+=this.wordwrap(this.getPrivateBaseKeyB64())+"\n";a+="-----END RSA PRIVATE KEY-----";return a};dG.prototype.getPublicKey=function(){var a="-----BEGIN PUBLIC KEY-----\n";a+=this.wordwrap(this.getPublicBaseKeyB64())+"\n";a+="-----END PUBLIC KEY-----";return a};dG.prototype.hasPublicKeyProperty=function(a){a=a||{};return a.hasOwnProperty('n')&&a.hasOwnProperty('e')};dG.prototype.hasPrivateKeyProperty=function(a){a=a||{};return a.hasOwnProperty('n')&&a.hasOwnProperty('e')&&a.hasOwnProperty('d')&&a.hasOwnProperty('p')&&a.hasOwnProperty('q')&&a.hasOwnProperty('dmp1')&&a.hasOwnProperty('dmq1')&&a.hasOwnProperty('coeff')};dG.prototype.parsePropertiesFrom=function(a){this.n=a.n;this.e=a.e;a.hasOwnProperty('d')&&(this.d=a.d,this.p=a.p,this.q=a.q,this.dmp1=a.dmp1,this.dmq1=a.dmq1,this.coeff=a.coeff)};class ec extends dG{constructor(a){super();a&&(typeof a==='string'?this.parseKey(a):(this.hasPrivateKeyProperty(a)||this.hasPublicKeyProperty(a))&&this.parsePropertiesFrom(a))}}class ed{constructor(a){a=a||{};this.default_key_size=parseInt(a.default_key_size)||1024;this.default_public_exponent=a.default_public_exponent||'010001';this.log=a.log||!1;this.key=null}}ed.prototype.setKey=function(a){this.log&&this.key&&console.warn('A key was already set, overriding existing.');this.key=new ec(a)};ed.prototype.setPrivateKey=function(a){this.setKey(a)};ed.prototype.setPublicKey=function(a){this.setKey(a)};ed.prototype.decrypt=function(a){try{return this.getKey().decrypt(eb(a))}catch(a){return !1}};ed.prototype.encrypt=function(a){try{return ea(this.getKey().encrypt(a))}catch(a){return !1}};ed.prototype.getKey=function(a){if(!this.key){this.key=new ec();if(a&&{}.toString.call(a)==='[object Function]'){this.key.generateAsync(this.default_key_size,this.default_public_exponent,a);return}this.key.generate(this.default_key_size,this.default_public_exponent)}return this.key};ed.prototype.getPrivateKey=function(){return this.getKey().getPrivateKey()};ed.prototype.getPrivateKeyB64=function(){return this.getKey().getPrivateBaseKeyB64()};ed.prototype.getPublicKey=function(){return this.getKey().getPublicKey()};ed.prototype.getPublicKeyB64=function(){return this.getKey().getPublicBaseKeyB64()};class ee{constructor(a,b,c={}){this.stream_type=b;this.endpoint=a;this.eventSource=new H();this.dataQueue=[]}static canTransfer(a){return ee.streamTypes().includes(a)}static streamTypes(){return[]}destroy(){this.eventSource.destroy()}connect(){}disconnect(){}reconnect(){return this.disconnect().then(()=>{return this.connect()})}setEndpoint(a){this.endpoint=a;return this.reconnect()}send(a){}prepare(a){}}let eg=1,eh="transport:ws",ei=u(eh);class ej extends ee{constructor(a,b,c={socket:`${location.protocol.replace('http','ws')}//${location.host}/ws/`,workers:1}){super(a,b);this.proxies=[];this.currentProxy=0;this.workers=1;this.socket_url=c.socket;this.ready=this.connect()}destroy(){return this.disconnect().then(()=>{return super.destroy()})}static canTransfer(a){return ej.streamTypes().includes(a)}static streamTypes(){return['hls','rtsp']}connect(){return this.disconnect().then(()=>{let a=[];for(let b=0;b<this.workers;++b){let c=new el(this.socket_url,this.endpoint,this.stream_type);c.set_disconnect_handler(a=>{this.eventSource.dispatchEvent('disconnected',{code:a.code,reason:a.reason});[1000,1006,1013,1011].includes(a.code)&&setTimeout(()=>{this.ready&&this.ready.reject&&this.ready.reject();this.ready=this.connect()},3000)});c.set_data_handler(a=>{this.dataQueue.push(new Uint8Array(a));this.eventSource.dispatchEvent('data')});a.push(c.connect().then(()=>{this.eventSource.dispatchEvent('connected')}).catch(a=>{this.eventSource.dispatchEvent('error');throw new Error(a)}));this.proxies.push(c)}return Promise.all(a)})}disconnect(){let a=[];for(let b=0;b<this.proxies.length;++b)a.push(this.proxies[b].close());this.proxies=[];if(this.proxies.length){return Promise.all(a)}else{return Promise.resolve()}}socket(){return this.proxies[this.currentProxy++%this.proxies.length]}send(a,b){let c=this.socket().send(a);b&&b(c.seq);return c.promise}}class ek{static get PROTO(){return'WSP'}static get V1_1(){return'1.1'}static get CMD_INIT(){return'INIT'}static get CMD_JOIN(){return'JOIN'}static get CMD_WRAP(){return'WRAP'}constructor(a){this.ver=a}build(a,b,c=''){let d='';b.seq||(b.seq=++ek.seq);for(let a in b)d+=`${a}: ${b[a]}\r\n`;return`${ek.PROTO}/${this.ver} ${a}\r\n${d}\r\n${c}`}static parse(a){let b=a.indexOf('\r\n\r\n'),c=a.substr(0,b).split('\r\n'),d=c.shift().match(new RegExp(`${ek.PROTO}/${ek.V1_1}\\s+(\\d+)\\s+(.+)`));if(d){let e={code:Number(d[1]),msg:d[2],data:{},payload:''};while(c.length){let a=c.shift();if(a){let[b,c]=a.split(':');e.data[b.trim()]=c.trim()}else{break}}e.payload=a.substr(b+4);return e}return null}}ek.seq=0;class el{static get CHN_CONTROL(){return'control'}static get CHN_DATA(){return'data'}constructor(a,b,c){this.url=a;this.stream_type=c;this.endpoint=b;this.data_handler=()=>{};this.disconnect_handler=()=>{};this.builder=new ek(ek.V1_1);this.awaitingPromises={};this.seq=0;this.encryptor=new ed()}set_data_handler(a){this.data_handler=a}set_disconnect_handler(a){this.disconnect_handler=a}close(){ei.log('closing connection');return new Promise(a=>{this.ctrlChannel.onclose=()=>{this.dataChannel?(this.dataChannel.onclose=()=>{ei.log('closed');a()},this.dataChannel.close()):(ei.log('closed'),a())};this.ctrlChannel.close()})}onDisconnect(){this.ctrlChannel.onclose=null;this.ctrlChannel.close();this.dataChannel&&(this.dataChannel.onclose=null,this.dataChannel.close());this.disconnect_handler(this)}initDataChannel(a){return new Promise((b,c)=>{this.dataChannel=new WebSocket(this.url+el.CHN_DATA);this.dataChannel.binaryType='arraybuffer';this.dataChannel.onopen=()=>{let b=this.builder.build(ek.CMD_JOIN,{channel:a});ei.debug(b);this.dataChannel.send(b)};this.dataChannel.onmessage=a=>{ei.debug(`[data]\r\n${a.data}`);let d=ek.parse(a.data);if(!d){return c()}this.dataChannel.onmessage=a=>{this.data_handler&&this.data_handler(a.data)};b()};this.dataChannel.onerror=a=>{ei.error(`[data] ${a.type}`);this.dataChannel.close()};this.dataChannel.onclose=a=>{ei.error(`[data] ${a.type}. code: ${a.code}, reason: ${a.reason||'unknown reason'}`);this.onDisconnect(a)}})}connect(){this.encryptionKey=null;return new Promise((a,b)=>{this.ctrlChannel=new WebSocket(this.url+el.CHN_CONTROL);this.connected=!1;this.ctrlChannel.onopen=()=>{let a={proto:this.stream_type};this.endpoint.socket?(a.socket=this.endpoint.socket):Object.assign(a,{host:this.endpoint.host,port:this.endpoint.port});let b=this.builder.build(ek.CMD_INIT,a);ei.debug(b);this.ctrlChannel.send(b)};this.ctrlChannel.onmessage=c=>{ei.debug(`[ctrl]\r\n${c.data}`);let d=ek.parse(c.data);if(!d){return b()}if(d.code>=300){ei.error(`[ctrl]\r\n${d.code}: ${d.msg}`);return b()}this.ctrlChannel.onmessage=a=>{let b=ek.parse(a.data);ei.debug(`[ctrl]\r\n${a.data}`);b.data.seq in this.awaitingPromises&&(b.code<300?this.awaitingPromises[b.data.seq].resolve(b):this.awaitingPromises[b.data.seq].reject(b),delete this.awaitingPromises[b.data.seq])};this.encryptionKey=d.data.pubkey||null;this.encryptionKey&&this.encryptor.setPublicKey(this.encryptionKey);this.initDataChannel(d.data.channel).then(a).catch(b)};this.ctrlChannel.onerror=a=>{ei.error(`[ctrl] ${a.type}`);this.ctrlChannel.close()};this.ctrlChannel.onclose=a=>{ei.error(`[ctrl] ${a.type}. code: ${a.code} ${a.reason||'unknown reason'}`);this.onDisconnect(a)}})}encrypt(a){if(this.encryptionKey){let b=this.encryptor.encrypt(a);if(b===!1){throw new Error("Encryption failed. Stopping")}return b}return a}send(a){if(this.ctrlChannel.readyState!=WebSocket.OPEN){this.close();throw new Error('disconnected')}let b={contentLength:a.length,seq:++ek.seq};return{seq:b.seq,promise:new Promise((c,d)=>{this.awaitingPromises[b.seq]={resolve:c,reject:d};let e=this.builder.build(ek.CMD_WRAP,b,a);ei.debug(e);this.ctrlChannel.send(this.encrypt(e))})}}}let em=u('wsp');class en{static get HLS(){return'hls'}static get RTSP(){return'rtsp'}static isSupported(a){return[en.HLS,en.RTSP].includes(a)}static fromUrl(a){let b;try{b=z.parse(a)}catch(a){return null};switch(b.protocol){case 'rtsp':return en.RTSP;case 'http':;case 'https':if(a.indexOf('.m3u8')>=0){return en.HLS}else{return null};default:return null}}static fromMime(a){switch(a){case 'application/x-rtsp':return en.RTSP;case 'application/vnd.apple.mpegurl':;case 'application/x-mpegurl':return en.HLS;default:return null}}}class eo{constructor(a,b){typeof a=="string"?(this.player=document.getElementById(a)):(this.player=a);let c=b.modules||{client:a_,transport:{constructor:ej}};this.errorHandler=b.errorHandler||null;this.queryCredentials=b.queryCredentials||null;this.modules={};for(let a of c){let b=a.transport||ej,d=a.client||a_;b.constructor.canTransfer(d.streamType())?(this.modules[d.streamType()]={client:d,transport:b}):em.warn(`Client stream type ${d.streamType()} is incompatible with transport types [${b.streamTypes().join(', ')}]. Skip`)}this.type=en.RTSP;this.url=null;if(b.url&&b.type)this.url=b.url,this.type=b.type;else{if(!this._checkSource(this.player)){for(let a=0;a<this.player.children.length;++a){if(this._checkSource(this.player.children[a])){break}}}}this.url&&this.setSource(this.url,this.type);this.player.addEventListener('play',()=>{this.isPlaying()||this.client.start()},!1);this.player.addEventListener('pause',()=>{this.client.stop()},!1);this.player.addEventListener('abort',()=>{this.client.stop();this.transport.disconnect().then(()=>{this.client.destroy()})},!1)}isPlaying(){return!(this.player.paused||this.client.paused)}static canPlayWithModules(a,b){let c={};for(let a of b){let d=a.transport||ej,e=a.client||a_;d.canTransfer(e.streamType())&&(c[e.streamType()]=!0)}for(let b in c){if(b==en.fromMime(a)){return !0}}return !1}static canPlay(a){return en.fromMime(a.type)||en.fromUrl(a.src)}canPlayUrl(a){let b=en.fromUrl(a);return b in this.modules}_checkSource(a){if(!a.dataset.ignore&&a.src&&!this.player.canPlayType(a.type)&&(en.fromMime(a.type)||en.fromUrl(a.src))){this.url=a.src;this.type=a.type?en.fromMime(a.type):en.fromUrl(a.src);return !0}return !1}async setSource(a,b){this.transport&&(this.client&&(await this.client.detachTransport()),await this.transport.destroy());try{this.endpoint=z.parse(a)}catch(a){return};this.url=a;let c=this.modules[b].transport;this.transport=new c.constructor(this.endpoint,this.type,c.options);let d=this.type;this.type=(en.isSupported(b)?b:!1)||en.fromMime(b);if(!this.type){throw new Error("Bad stream type")}if(d!=this.type||!this.client){this.client&&(await this.client.destroy());let a=this.modules[b].client;this.client=new a()}else this.client.reset();this.queryCredentials&&(this.client.queryCredentials=this.queryCredentials);this.remuxer&&(this.remuxer.destroy(),this.remuxer=null);this.remuxer=new ai(this.player);this.remuxer.attachClient(this.client);this.client.attachTransport(this.transport);this.client.setSource(this.endpoint);this.player.autoplay&&this.start()}start(){this.client&&this.client.start().catch(a=>{this.errorHandler&&this.errorHandler(a)})}stop(){this.client&&this.client.stop()}async destroy(){this.transport&&(this.client&&(await this.client.detachTransport()),await this.transport.destroy());this.client&&(await this.client.destroy());this.remuxer&&(this.remuxer.destroy(),this.remuxer=null)}}class ep{constructor(){this.fragments=[];this.pesLength=0;this.pesPkt=null}parse(a){if(this.extPresent){let b=this.parseExtension(a);b.data=a.subarray(b.offset)}else{return null}}parseHeader(){let a=this.fragments[0],b=(a[0]<<16)+(a[1]<<8)+a[2];this.extPresent=![0xbe,0xbf].includes(a[3]);if(b===1){let b=(a[4]<<8)+a[5];b?(this.pesLength=b,this.hasLength=!0):(this.hasLength=!1,this.pesPkt=null);return !0}return !1}static PTSNormalize(a,b){let c;if(b===undefined){return a}b<a?(c=-8589934592):(c=8589934592);while(Math.abs(a-b)>4294967296)a+=c;return a}parseExtension(a){let b,c,d,e,f;b=a[1];if(b&0xC0){d=(a[3]&0x0E)*536870912+(a[4]&0xFF)*4194304+(a[5]&0xFE)*16384+(a[6]&0xFF)*128+(a[7]&0xFE)/2;d>4294967295&&(d-=8589934592);b&0x40?(e=(a[8]&0x0E)*536870912+(a[9]&0xFF)*4194304+(a[10]&0xFE)*16384+(a[11]&0xFF)*128+(a[12]&0xFE)/2,e>4294967295&&(e-=8589934592)):(e=d);c=a[2];f=c+9;return{offset:f,pts:d,dts:e}}else{return null}}feed(a,b){let c=null;if(b&&this.fragments.length){if(!this.parseHeader()){throw new Error("Invalid PES packet")}let a=6,b={};this.extPresent&&(b=this.parseExtension(this.fragments[0].subarray(6)),a=b.offset);this.pesPkt||(this.pesPkt=new Uint8Array(this.pesLength));let d=0;while(this.pesLength&&this.fragments.length){let b=this.fragments.shift();if(a){if(b.byteLength<a){a-=b.byteLength;continue}else b=b.subarray(a),this.pesLength-=a-(this.hasLength?6:0),a=0}this.pesPkt.set(b,d);d+=b.byteLength;this.pesLength-=b.byteLength}c={data:this.pesPkt,pts:b.pts,dts:b.dts}}else this.pesPkt=null;this.pesLength+=a.byteLength;this.fragments.length&&this.fragments[this.fragments.length-1].byteLength<6?(this.fragments[this.fragments.length-1]=X(this.fragments[0],a)):this.fragments.push(a);return c}}class eq{static get AAC(){return 0x0f}static get ID3(){return 0x15}static get H264(){return 0x1b}}class er{static get PACKET_LENGTH(){return 188}constructor(){this.pmtParsed=!1;this.pesParserTypes=new Map();this.pesParsers=new Map();this.pesAsms={};this.ontracks=null;this.toSkip=0}addPesParser(a,b){this.pesParserTypes.set(a,b)}parse(a){let b=new $(a);if(a[0]===0x47){b.skipBits(9);let c=b.readBits(1);b.skipBits(1);let d=b.readBits(13);b.skipBits(2);let e=b.readBits(1),f=b.readBits(1);b.skipBits(4);if(e){let a=b.readBits(8);this.toSkip=b.skipBits(a*8);if(b.finished()){return}}if(!f)return;let g=a.subarray(b.bytepos);if(this.pmtParsed&&this.pesParsers.has(d)){let a=this.pesAsms[d].feed(g,c);if(a){return this.pesParsers.get(d).parse(a)}}else d===0?(this.pmtId=this.parsePAT(g)):d===this.pmtId&&(this.parsePMT(g),this.pmtParsed=!0)}return null}parsePAT(a){let b=new $(a),c=b.readBits(8);b.skipBits(8*c+83);return b.readBits(13)}parsePMT(a){let b=new $(a),c=b.readBits(8);b.skipBits(8*c+8);b.skipBits(6);let d=b.readBits(10);b.skipBits(62);let e=b.readBits(10);b.skipBits(e*8);let f=new Set(),g=d-13-e;while(g>0){let a=b.readBits(8);b.skipBits(3);let c=b.readBits(13);b.skipBits(6);let d=b.readBits(10);b.skipBits(d*8);if([eq.AAC,eq.H264].includes(a)){if(this.pesParserTypes.has(a)&&!this.pesParsers.has(c)){this.pesParsers.set(c,new (this.pesParserTypes.get(a)));this.pesAsms[c]=new ep();switch(a){case eq.H264:f.add({type:af.H264,offset:0});break;case eq.AAC:f.add({type:af.AAC,offset:0});break}}}g-=5+d}this.ontracks&&this.ontracks(f)}}class es{constructor(){this.naluasm=new aN();this.lastUnit=null}parse(a){let b=a.data,c=0,d=b.byteLength,e,f,g=0,h=[],i;while(c<d){e=b[c++];switch(g){case 0:e===0&&(g=1);break;case 1:e===0?(g=2):(g=0);break;case 2:;case 3:if(e===0)g=3;else if(e===1&&c<d){if(i){let d=this.naluasm.onNALUFragment(b.subarray(i,c-g-1),a.dts);d&&d.type() in aa.TYPES&&h.push(d)}else f=c-g-1,f&&(this.lastUnit&&(this.lastUnit.data=X(this.lastUnit.data.byteLength,b.subarray(0,f))));i=c;g=0}else g=0;break;default:break}}if(i){let c=this.naluasm.onNALUFragment(b.subarray(i,d),a.dts,a.pts);c&&h.push(c)}this.lastUnit=h[h.length-1];return{units:h,type:ae.VIDEO,pay:af.H264}}}class et{static parseHeader(a){let b=new $(a);b.skipBits(15);let c=b.readBits(1);b.skipBits(14);let d=b.readBits(13);b.skipBits(11);let e=b.readBits(2);c||b.skipBits(16);return{size:d-b.bytepos,frameCount:e,offset:b.bytepos}}static parseHeaderConfig(a){let b=new $(a);b.skipBits(15);let c=b.readBits(1),d=b.readBits(2)+1,e=b.readBits(4);b.skipBits(1);let f=b.readBits(3);b.skipBits(4);let g=b.readBits(13);b.skipBits(11);let h=b.readBits(2);c||b.skipBits(16);let i=navigator.userAgent.toLowerCase(),j=4,k;i.indexOf('firefox')!==-1?(e>=6?(d=5,j=4,k=e-3):(d=2,j=2,k=e)):i.indexOf('android')!==-1?(d=2,j=2,k=e):(d=5,j=4,e>=6?(k=e-3):(f===1&&(d=2,j=2),k=e));let l=new Uint8Array(j);l[0]=d<<3;l[0]|=(e&0x0E)>>1;l[1]|=(e&0x01)<<7;l[1]|=f<<3;d===5&&(l[1]|=(k&0x0E)>>1,l[2]=(k&0x01)<<7,l[2]|=8,l[3]=0);return{config:{config:l,codec:`mp4a.40.${d}`,samplerate:aU.SampleRates[e],channels:f},size:g-b.bytepos,frameCount:h,offset:b.bytepos}}}class eu{constructor(){this.aacOverFlow=null;this.lastAacPTS=null;this.track={};this.config=null}parse(a){let b=a.data,c=a.pts,d=0,e=this.aacOverFlow,f=this.lastAacPTS;var g,h,i,j,k;if(e){var l=new Uint8Array(e.byteLength+b.byteLength);l.set(e,0);l.set(b,e.byteLength);v.debug(`AAC: append overflowing ${e.byteLength} bytes to beginning of new PES`);b=l}for(i=d, k=b.length;i<k-1;i++){if(b[i]===0xff&&(b[i+1]&0xf0)===0xf0){break}}if(i){var m,n;i<k-1?(m=`AAC PES did not start with ADTS header,offset:${i}`,n=!1):(m='no ADTS header found in AAC PES',n=!0);v.error(m);if(n){return}}let o=null,p={units:[],type:ae.AUDIO,pay:af.AAC};this.config||(o=et.parseHeaderConfig(b.subarray(i)),this.config=o.config,p.config=o.config,o.config=null,v.debug(`parsed codec:${this.config.codec},rate:${this.config.samplerate},nb channel:${this.config.channels}`));h=0;g=92160000/this.config.samplerate;if(e&&f){var q=f+g;Math.abs(q-c)>1&&(v.debug(`AAC: align PTS for overlapping frames by ${Math.round((q-c)/90)}`),c=q)}while(i+5<k){o||(o=et.parseHeader(b.subarray(i)));if(o.size>0&&i+o.offset+o.size<=k){j=c+h*g;p.units.push(new aO(b.subarray(i+o.offset,i+o.offset+o.size),j));i+=o.offset+o.size;h++;for(;i<k-1;i++){if(b[i]===0xff&&(b[i+1]&0xf0)===0xf0){break}}}else{break}o=null}i<k&&b[i]==0xff?(e=b.subarray(i,k)):(e=null);this.aacOverFlow=e;this.lastAacPTS=j;return p}}class ew{constructor(a){typeof a==='string'&&(a=ew.parseAttrList(a));for(var b in a)a.hasOwnProperty(b)&&(this[b]=a[b]);this.attrs=a}decimalInteger(a){let b=parseInt(this[a],10);if(b>Number.MAX_SAFE_INTEGER){return Infinity}return b}hexadecimalInteger(a){if(this[a]){let b=(this[a]||'0x').slice(2);b=(b.length&1?'0':'')+b;let c=new Uint8Array(b.length/2);for(let a=0;a<b.length/2;a++)c[a]=parseInt(b.slice(a*2,a*2+2),16);return c}else{return null}}hexadecimalIntegerAsNumber(a){let b=parseInt(this[a],16);if(b>Number.MAX_SAFE_INTEGER){return Infinity}return b}decimalFloatingPoint(a){return parseFloat(this[a])}enumeratedString(a){return this[a]}decimalResolution(a){let b=/^(\d+)x(\d+)$/.exec(this[a]);if(b===null){return undefined}return{width:parseInt(b[1],10),height:parseInt(b[2],10)}}static parseAttrList(a){let b=/\s*(.+?)\s*=((?:\".*?\")|.*?)(?:,|$)/g;var c,d={};while((c=b.exec(a))!==null){var e=c[2],f='"';e.indexOf(f)===0&&e.lastIndexOf(f)===e.length-1&&(e=e.slice(1,-1));d[c[1]]=e}return d}}class ey{static get TYPE_CHUNK(){return 0}static get TYPE_PLAYLIST(){return 1}static parse(a,b=''){a=a.replace(/\r/,'').split('\n');if(a.shift().indexOf('#EXTM3U')<0){throw new Error("Bad playlist")}let c=[],d=[],e=!1,f={},g=null;while(a.length){let h=a.shift().replace(/\r/,'');if(e){if(h){f.url=h.startsWith('http')?h:`${b}/${h}`;switch(g){case ey.TYPE_CHUNK:c.push(f);break;case ey.TYPE_PLAYLIST:d.push(f);break};f={};e=!1}}else{if(h.startsWith('#EXTINF'))f.duration=Number(h.split(':')[1].split(',')[0]),g=ey.TYPE_CHUNK,e=!0;else if(h.startsWith('#EXT-X-STREAM-INF')){let a=h.split(':')[1],b=new ew(a);for(let a in b.attrs)f[a.toLowerCase()]=b.attrs[a];g=ey.TYPE_PLAYLIST;e=!0}}}return{chunks:c,playlists:d}}}let ez="client:hls",eA=u(ez);class eB extends aT{static get CHUNKS_TO_LOAD(){return eg}constructor(a,b){super(a,b);this.parser=new er();this.parser.addPesParser(eq.H264,es);this.parser.addPesParser(eq.AAC,eu);this.parser.ontracks=a=>{let b=0;for(let a of this.chunks)b+=a.duration;for(let c of a)c.duration=b,this.sampleQueues[c.type]=[];this.eventSource.dispatchEvent('tracks',a);this.startStreamFlush()};this.playlists=[];this.chunks=[];this.loadedChunks=[];this.pendingChunks=new Set();this.chunkIdx=0;this.seqMap=new Map();this.sampleQueues={};this.chunkSeq=new Map();this.eventSource.addEventListener('needData',this.loadChunks.bind(this,eB.CHUNKS_TO_LOAD));this.resume=!1;this.parsing=!1}static streamType(){return'hls'}parse(a){let c=4;while(c<a.byteLength){let b=this.parser.parse(a.subarray(c,c+er.PACKET_LENGTH));b&&(b.config&&this.eventSource.dispatchEvent(`${ae.map[b.type]}_config`,{config:b.config,pay:b.pay}),this.sampleQueues[b.type].push(b.units),this.eventSource.dispatchEvent('samples',{pay:b.pay}));c+=er.PACKET_LENGTH}this.parsing=!1;this.loadedChunks.length&&this.onData(this.loadedChunks.shift())}checkSeq(a,b){a=Number(a);if(this.seqMap.has(a)){let c=this.chunkSeq.get(a);this.pendingChunks.delete(c.idx);this.chunkSeq.delete(a);this.parse(b?b:this.seqMap.get(a));this.seqMap.delete(a);c.promise.resolve()}else this.seqMap.set(a,b)}onData(a){if(this.parsing)this.loadedChunks.push(a);else{this.parsing=!0;let b=new DataView(a.buffer,a.byteOffset,4).getUint32(0);this.checkSeq(b,a)}}onConnected(){super.onConnected();eA.debug('HLS connected');this.paused||this.start()}onDisconnected(){super.onDisconnected();eA.debug('HLS disconnected');this.parsing=!1;this.seqMap.clear();this.chunkSeq.clear()}start(){super.start();this.resume?this.eventSource.dispatchEvent('needData'):(this.resume=!0,this.eventSource.dispatchEvent('clear'),eA.debug('waiting for transport ready'),this.transport.ready.then(()=>{eA.debug('loading playlist');this.loadPlaylist()}).catch(a=>{eA.debug('reject transport',a)}))}stop(){super.stop()}setSource(a){this.resume=!1;super.setSource(a)}send(a,b){try{return this.transport.send(a,b)}catch(a){eA.error(a);this.onDisconnected();this.transport.connect();return Promise.reject()}}loadPlaylist(a=null){let b=a?a.url:this.sourceUrl;this.send(`GET ${b} HTTP/1.1\r\nHost: ${this.transport.endpoint.host}\r\n\r\n`).then(a=>{let c=a.payload.split('\r\n\r\n'),d=c[0].split('\r\n'),e=d[0].match(new RegExp("HTTP/\\\\d\\\\.\\\\d\\\\s+(\\\\d+)\\\\s+(\\\\w+)"));if(!e||e[1]>=400){eA.error('bad playlist response');return}eA.debug(e);let f=b.substr(0,b.lastIndexOf('/')),g=ey.parse(c[1],f);g.chunks.length?(this.chunks=g.chunks,this.resume=!0,this.loadChunks(1)):g.playlists&&(this.playlists=g.playlists,this.loadPlaylist(this.playlists[0]))}).catch(a=>{this.resume=!1})}loadChunk(a,b){return new Promise((c,d)=>{this.send(`GET ${a.url}?${Math.random()} HTTP/1.1\r\nHost: ${this.transport.endpoint.host}\r\n\r\n`,a=>{this.chunkSeq.set(a,{idx:b,promise:{resolve:c,reject:d}})}).then(a=>{let b=a.payload.split('\r\n'),[c,d,e]=b[0].split(' ');if(Number(d)>=300){throw new Error(`Load error: ${d} ${e}`)}this.checkSeq(a.data.seq,null)})})}loadChunks(a){if(this.chunkIdx>=this.chunks.length)return;let b=[];if(this.pendingChunks.size){eA.debug(`Reload chunks: ${Array.from(this.pendingChunks)}`);for(let a of this.pendingChunks){let c=this.chunks[a];eA.log(`Loading ${c.url} (${a+1} of ${this.chunks.length})`);b.push(this.loadChunk(c,a))}}else{for(let c=this.chunkIdx;c<this.chunkIdx+a;++c){let d=this.chunks[c];eA.log(`Loading ${d.url} (${c+1} of ${this.chunks.length})`);this.pendingChunks.add(c);b.push(this.loadChunk(d,c));if(c+1>=this.chunks.length)return}}return Promise.all(b).then(()=>{eA.log('chunk loaded');this.chunkIdx+=eB.CHUNKS_TO_LOAD;this.paused||this.eventSource.dispatchEvent('needData')}).catch(a=>{eA.error(a)})}}class eC{constructor(a,b,c){var d=f.getPlayer(c.playerId);this.playerOptions=d.options_;this.tech=b;this.transport={constructor:ej,options:{socket:this.playerOptions.rtsp_config.websocket_url}};this.player=new eo(b.el(),{modules:[{client:a_,transport:this.transport},{client:eB,transport:this.transport}]})}}var eD={canHandleSource:function(a){return this.canPlayType(a.type)},handleSource:function(a,b,c){return new eC(a,b,c)},canPlayType:function(a){var b='';eo.canPlayWithModules(a,[{client:a_,transport:ej},{client:eB,transport:ej}])&&(b='probably');return b}};f.getTech('Html5').registerSourceHandler(eD,0)}))
//# sourceMappingURL=videojs.streamedian.bundle.js.map
